

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/con1.png">
  <link rel="icon" href="/img/con1.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="“无论最终结果将人类历史导向何处，我们决定选择希望”">
  <meta name="author" content="友人律 | Guilin Chang">
  <meta name="keywords" content="三差学生、不学无术">
  <meta name="description" content="推荐阅读官方文档：https:&#x2F;&#x2F;www.chisel-lang.org&#x2F;chisel3&#x2F;docs&#x2F;introduction.html 官方速记手册： 官方github：https:&#x2F;&#x2F;github.com&#x2F;chipsalliance&#x2F;chisel3 0 Chisel的常见问题（必读）（1）Firrtl中间格式：Chisel是寄宿在Scala里的语言，所以它本质还是Scala。为了从Chisel转">
<meta property="og:type" content="article">
<meta property="og:title" content="Chisel（一）：初步">
<meta property="og:url" content="http://yoursite.com/202203091915/IC/Chieslessay/cs/scala/2022-3-9-chisel/index.html">
<meta property="og:site_name" content="友人律的博客">
<meta property="og:description" content="推荐阅读官方文档：https:&#x2F;&#x2F;www.chisel-lang.org&#x2F;chisel3&#x2F;docs&#x2F;introduction.html 官方速记手册： 官方github：https:&#x2F;&#x2F;github.com&#x2F;chipsalliance&#x2F;chisel3 0 Chisel的常见问题（必读）（1）Firrtl中间格式：Chisel是寄宿在Scala里的语言，所以它本质还是Scala。为了从Chisel转">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MjkxNTA1,size_16,color_FFFFFF,t_70.png">
<meta property="og:image" content="http://yoursite.com/202203091915/IC/Chieslessay/cs/scala/2022-3-9-chisel/2022-3-9-chisel/image-20220313172534854.png">
<meta property="og:image" content="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p2.jpg">
<meta property="og:image" content="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p3.jpg">
<meta property="og:image" content="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p4.jpg">
<meta property="article:published_time" content="2022-03-09T11:15:00.000Z">
<meta property="article:modified_time" content="2022-03-13T11:20:52.532Z">
<meta property="article:author" content="友人律 | Guilin Chang">
<meta property="article:tag" content="IC">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MjkxNTA1,size_16,color_FFFFFF,t_70.png">
  
  <title>Chisel（一）：初步 - 友人律的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/stackoverflow-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"eca4a4d34dadf0d4e282cc6ef2dc3de6","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body><!-- hexo injector body_begin start -->
<link defer rel="stylesheet" href="/css/article_para.css" />
<div id="web_bg"></div><!-- hexo injector body_begin end -->
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>友人律的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E9%80%9A%E7%9F%A5/">
                <i class="iconfont icon-link-fill"></i>
                通知
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E9%A1%B9%E7%9B%AE%E4%B8%8E%E8%AE%BE%E8%AE%A1/">
                <i class="iconfont icon-link-fill"></i>
                项目与设计
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">
                <i class="iconfont icon-link-fill"></i>
                开发工具
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/CS/">
                <i class="iconfont icon-link-fill"></i>
                CS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/IC/">
                <i class="iconfont icon-link-fill"></i>
                IC
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p4.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Chisel（一）：初步">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-09 19:15" pubdate>
        2022年3月9日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      43k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      135 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Chisel（一）：初步</h1>
            
            <div class="markdown-body">
              <p>推荐阅读官方文档：<a target="_blank" rel="noopener" href="https://www.chisel-lang.org/chisel3/docs/introduction.html">https://www.chisel-lang.org/chisel3/docs/introduction.html</a></p>
<p>官方速记手册：</p>
<p>官方github：<a target="_blank" rel="noopener" href="https://github.com/chipsalliance/chisel3">https://github.com/chipsalliance/chisel3</a></p>
<h1 id="0-Chisel的常见问题（必读）"><a href="#0-Chisel的常见问题（必读）" class="headerlink" title="0 Chisel的常见问题（必读）"></a>0 Chisel的常见问题（必读）</h1><p>（1）<strong>Firrtl中间格式：</strong>Chisel是寄宿在Scala里的语言，所以它本质还是Scala。为了从Chisel转变成Verilog，语言开发人员开发了一个中间的标准交换格式——Firrtl，它跟Vrilog是同一级别的，两者都比Chisel低一级。编写的Chisel代码首先会经过Firrtl编译器，生成Firrtl代码，也就是一个后缀格式为“.fir”的文件，然后由这个Firrtl文件再去生成对应的Verilog代码。如果读者有兴趣看一看Firrtl的格式，其实与Verilog很接近，只不过是由机器生成的、很死板的代码。Firrtl编译器也并不是只针对Chisel，有兴趣和能力的读者也可以开发针对Java、Python、C++等语言的Firrtl编译器。因为Firrtl只是一种标准的中间媒介，如何从一端到另一端，完全是自定义的。另外，Firrtl也并不仅仅是生成Verilog，同样可以开发工具生成VHDL、SystemVerilog等语言</p>
<p>（2）<u>Chisel与Firrtl双检查：</u>Scala里的语法，在Chisel里也基本能用，比如Scala的基本值类、内建控制结构、函数抽象、柯里化、模式匹配、隐式参数等等。但是读者要记住这些代码不仅要通过Scala编译器的检查，还需要通过Firrtl编译器的检查</p>
<p>（3）<strong>Chisel完全可综合：</strong>Verilog的最初目的是用于电路验证，所以它有很多不可综合的语法。Firrtl在转变成Verilog时，只会采用可综合的语法，因此读者完全不用担心用Chisel写出来的电路不可综合。只要能正确生成Verilog，那就能被综合器生成电路</p>
<p>（4）<strong>Chisel只支持二值逻辑：</strong>Chisel目前<strong>只支持0和1</strong>，<strong>不支持四态逻辑里的x和z</strong>。由于只有芯片对外的IO处才能出现三态门，所以内部设计几乎用不到x和z。而且x和z在设计中会带来危害，忽略掉它们也不影响大多数设计，还简化了模型。当然，<u>如果确实需要，可以通过黑盒语法与外部的Verilog代码互动，也可以在下游工具链里添加四态逻辑</u></p>
<p>（5）<strong>Chisel检查未驱动：</strong>Chisel会对未被驱动的输出型端口和线网进行检测，如果存在，会进行报错。报错选项可以关闭和打开，取决于读者对设计模型的需求。推荐把该选项打开，尽量不要残留无用的声明。</p>
<p>（6）<mark><strong>Chisel需手动导环境包：</strong></mark>Chisel的代码包并不会像Scala的标准库那样被编译器隐式导入，所以每个Chisel文件都应该在开头都需要导包</p>
<ul>
<li>import chisel3._：必选，包含了基本语法</li>
<li>import chisel3.util._：高级语法必选</li>
<li>import chisel3.experimental._：高级语法必选</li>
<li>import chisel3.testers._：高级语法必选</li>
</ul>
<p>（7）<strong>不同层次打包封装：</strong>应该用一个名字有意义的包来打包实现某个功能的文件集。例如，要实现一个自定义的微处理器，则可以把顶层包命名为“mycpu”，进而再划分成“myio”、“mymem”、“mybus”、“myalu”等子包，每个子包里包含相关的源文件。</p>
<p>Chisel现在仍在更新中，很可能会添加新功能或删去老功能。因此，本教程介绍的内容在将来并不一定就正确，读者应该持续关注Chisel3的GitHub的发展动向</p>
<h1 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1 环境搭建"></a>1 环境搭建</h1><p>以下环境搭建基于Ubuntu16.04</p>
<h2 id="1-1-Java安装"><a href="#1-1-Java安装" class="headerlink" title="1.1 Java安装"></a>1.1 Java安装</h2><p>根据下面这个博客来的，但在修改环境变量处出现了问题，导致无法进入系统（详情参考本博客《解决Ubuntu修改环境变量后导致登录循环进不去系统的问题》）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41204464/article/details/90314834">https://blog.csdn.net/qq_41204464/article/details/90314834</a></p>
<p><strong>下载安装包</strong></p>
<p>​    记得下载Linux64位的<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html">官网地址</a></p>
<p><strong>解压并移动</strong></p>
<p>​    解压并移动到<code>/usr/lib/jdk</code>目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tar -zxvf ./jdk-8u311-linux-x64.tar.gz<br>mkdir /usr/lib/jdk<br>mv ./jdk1.8.0_311 /usr/lib/jdk/<br></code></pre></div></td></tr></table></figure>
<p><strong>修改环境变量</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">sudo gedit /etc/profile<br></code></pre></div></td></tr></table></figure>
<p>​    在文件的<strong>最后</strong>添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs make"># JDK,TOMCAT,ORACLE<br>export JAVA_HOME=/home/pu/jdk1.8.0_211<br>export JRE_HOME=$JAVA_HOME/jre<br><br># two sentence belong may crash your env<br># export CLASSPATH=.:$JAVA_HOME/lib:$JRE_HOME/lib <br># export PATH=$PATH:$JAVA_HOME/bin<br></code></pre></div></td></tr></table></figure>
<p><strong>测试环境变量是否出问题</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> /etc/profile <br></code></pre></div></td></tr></table></figure>
<p>​    如果运行后发现环境变量失效，则修改有问题</p>
<h2 id="1-2-Scala安装"><a href="#1-2-Scala安装" class="headerlink" title="1.2 Scala安装"></a>1.2 Scala安装</h2><p>随便从官网找一个安装包<a target="_blank" rel="noopener" href="https://www.scala-lang.org/download/all.html，我这里用的rpm安装包，省的我再配置环境变量了">https://www.scala-lang.org/download/all.html，我这里用的rpm安装包，省的我再配置环境变量了</a></p>
<p><strong>安装rpm</strong>使用命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">sudo rpm  -ivh ./scala-2.11.8.rpm<br></code></pre></div></td></tr></table></figure>
<p><strong>安装sbt</strong>(官网<a target="_blank" rel="noopener" href="https://www.scala-sbt.org/download.html)：">https://www.scala-sbt.org/download.html)：</a></p>
<blockquote>
<p>Scala开发环境，官方名字叫“sbt”，最好选择最新的发布版本的安装，不然你还得蛋疼得安装一个叫<a target="_blank" rel="noopener" href="https://github.com/ucb-bar/firrtl">Firrtl</a> 的软件。这个需要先下载再安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb https://repo.scala-sbt.org/scalasbt/debian all main&quot;</span> | sudo tee /etc/apt/sources.list.d/sbt.list<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb https://repo.scala-sbt.org/scalasbt/debian /&quot;</span> | sudo tee /etc/apt/sources.list.d/sbt_old.list<br>curl -sL <span class="hljs-string">&quot;https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823&quot;</span> | sudo apt-key add<br>sudo apt-get update<br>sudo apt-get install sbt<br></code></pre></div></td></tr></table></figure>
<p><strong>sbt安装完检查：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">sbt<br>sbt -version<br>sbt version <span class="hljs-keyword">in</span> this project: 1.6.2<br>sbt script version: 1.6.2<br></code></pre></div></td></tr></table></figure>
<h2 id="1-3-安装Verilator"><a href="#1-3-安装Verilator" class="headerlink" title="1.3 安装Verilator"></a>1.3 安装Verilator</h2><p><strong>执行命令：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">sudo apt-get install verilator <br><br>verilator -version<br>Verilator 3.904 2017-05-30 rev verilator_3_904 <br></code></pre></div></td></tr></table></figure>
<h2 id="1-4-Chisel安装"><a href="#1-4-Chisel安装" class="headerlink" title="1.4 Chisel安装"></a>1.4 Chisel安装</h2><p><strong>参考官方文档：</strong></p>
<ul>
<li>template：<a target="_blank" rel="noopener" href="https://github.com/freechipsproject/chisel-template">https://github.com/freechipsproject/chisel-template</a></li>
<li>doc：<a target="_blank" rel="noopener" href="https://github.com/chipsalliance/chisel3">https://github.com/chipsalliance/chisel3</a></li>
<li>homepage：<a target="_blank" rel="noopener" href="https://www.chisel-lang.org/">https://www.chisel-lang.org/</a></li>
</ul>
<p><strong>参考指导博客：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34291505/article/details/87365907">https://blog.csdn.net/qq_34291505/article/details/87365907</a></li>
</ul>
<h3 id="方法一：直接git-clone-template"><a href="#方法一：直接git-clone-template" class="headerlink" title="方法一：直接git clone template"></a>方法一：直接git clone template</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/freechipsproject/chisel-template <br></code></pre></div></td></tr></table></figure>
<h2 id="1-10-第一个工程"><a href="#1-10-第一个工程" class="headerlink" title="1.10 第一个工程"></a>1.10 第一个工程</h2><ul>
<li>对于小规模电路，可以直接用Chisel写testbench文件，然后联合Verilator生成C++文件来仿真，输出波形图。该方法会在后续章节介绍。</li>
<li>对于大规模电路，Verilator仿真很吃力，建议还是用生成的Verilog文件在专业EDA工具里仿真。当前Chisel不支持UVM，也没有工具支持Chisel，所以尽量用别的工具做测试</li>
</ul>
<h1 id="2-数据类型"><a href="#2-数据类型" class="headerlink" title="2 数据类型"></a>2 数据类型</h1><p>读者在学习本章后，<strong>应该理清Chisel数据类型的关系</strong>。</p>
<p><strong>常用的类型就五种</strong>，重点学会这五种即可：</p>
<ul>
<li>UInt</li>
<li>SInt</li>
<li>Bool</li>
<li>Bundle</li>
<li>Vec[T]</li>
</ul>
<p><strong>三种值类</strong>：UInt、SInt和Bool的操作符与Verilog差不多，很快就能理解。</p>
<h2 id="2-1-Chisel的数据类型"><a href="#2-1-Chisel的数据类型" class="headerlink" title="2.1 Chisel的数据类型"></a>2.1 Chisel的数据类型</h2><p>Chisel定义了自己的一套数据类型，读者应该跟Scala的九种基本值类区分开来。</p>
<p>Scala中数据类型在Chisel用于参数和内建控制结构</p>
<p>Chisel自己的数据类型用于构建硬件电路还是得用</p>
<p>Chisel定义的数据类型如下图所示，其中<strong>绿色方块是class</strong>，<strong>红色是object</strong>，<strong>蓝色是trait</strong>，<strong>箭头指向的是超类和混入的特质</strong>： </p>
<p><img src="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0MjkxNTA1,size_16,color_FFFFFF,t_70.png" srcset="/img/loading.gif" lazyload alt="Chisel的数据类型关系图"></p>
<ul>
<li><p><strong>Data类：所有数据类型都继承自抽象基类Data</strong>，它混入了两个特质HasId和NamedComponent。如果读者查看Chisel3的源代码，就会看到很多参数传递时都用下界表明了是Data的子类。<u>在实际硬件构成里，并不会用到Data</u>，读者也不用关心它的具体实现细节。更多的，应该关注Data类的两大子类：聚合类Aggregate和元素类Element。</p>
</li>
<li><p><strong>Aggregate聚合类：</strong>Aggregate聚合类常用子类是<strong>向量类Vec[T]和包裹类Bundle</strong></p>
<ul>
<li><strong>Vec[T]子类：</strong>用于<strong>包含相同的元素</strong>，元素类型T可以是任意的Data子类。因为Vec[T]混入了特质IndexedSeq[T]，所以向量的元素能从下标0开始索引访问</li>
<li><strong>Bundle子类</strong>：用于<strong>被自定义的类继承，这样自定义的类就能包含任意Data的子类对象</strong>，常用于<strong>协助构造模块的端口</strong>，故而衍生出了一些预定义的端口子类</li>
<li>MixedVec[T]子类：混合向量类是Chisel3.2以上版本添加的语法，它与Vec[T]的不同在于<strong>可以包含不同类型的元素</strong>。</li>
</ul>
</li>
<li><p><strong>Element类：</strong>衍生出了Analog、Bits和Clock三个子类，单例对象DontCare和特质Reset</p>
<ul>
<li><strong>Analog子类：</strong>用于<strong>在黑盒中模拟inout端口</strong>，目前在实际Chisel里并无其他用途</li>
<li><strong>Bits子类：</strong>的两个子类SInt和UInt是最常用的两个数据类型，它们是用补码表示的有符号整数和无符号整数。不仅用来协助定义端口位宽，还用来进行赋值</li>
<li>FixedPoint子类提供的API带有试验性质，而且将来可能会发生改变，所以不常用</li>
<li><strong>Bool子类：</strong>是Chisel自己的布尔类型，<strong>区别于Scala的Boolean</strong>。Bool类是UInt类的子类，因为它可以看成是1bit的UInt，而且它被混入Reset特质，因为复位信号都是用Bool类型的线网或寄存器使能的。此外，Bits类混入了特质ToBoolable，也就是说FixedPoint、SInt和UInt都能转换成多bit的Bool类型</li>
<li><strong>Clock类：</strong>表示时钟，Chisel里的时钟是专门的一个类型，并不像Verilog里那样是1bit的线网。复位类型Reset也是如此</li>
<li><strong>Reset特质</strong>：表示复位，Chisel里的特质是专门的一个特质，并不像Verilog里那样是1bit的线网</li>
<li><strong>DontCare单例对象：</strong>用于赋值给未驱动的端口或线网，防止编译器报错。</li>
</ul>
</li>
</ul>
<h2 id="2-2-能表示数据的字面量"><a href="#2-2-能表示数据的字面量" class="headerlink" title="2.2 能表示数据的字面量"></a>2.2 能表示数据的字面量</h2><p><strong>字面量（literal）</strong>：有直接意义的，能直接表示的固定值</p>
<p><strong>BigInt、Int、Long和String四种类型的Scala字面量来构造UInt和SInt，具体分类两类：</strong></p>
<ul>
<li>数值字面量</li>
<li>字符串字面量</li>
</ul>
<hr>
<p><strong>（1）Chisel具体数的数据类型：</strong>    </p>
<p>能够表示具体值的数据类型为<strong>UInt、SInt和Bool</strong>。实际可综合的电路都是若干个bit，所以只能表示整数，这与Verilog是一致的。</p>
<p><strong>要表示浮点数，本质还是用多个bit来构建</strong>，而且要遵循IEEE的浮点标准。</p>
<p><strong>（2）Chisel中的UInt、SInt、Bool：</strong></p>
<ul>
<li>对于UInt，可以构成任意位宽的线网或寄存器</li>
<li>对于SInt，在Chisel里会按补码解读，转换成Verilog后会使用系统函数$signed，这是可综合的</li>
<li>对于Bool，转换成Verilog后就是1bit的线网或寄存器</li>
</ul>
<p><strong>（3）如何用字面量表示数：</strong></p>
<blockquote>
<p>要表示值，则必须有相应的字面量。Chisel定义了一系列隐式类：fromBigIntToLiteral、fromtIntToLiteral、fromtLongToLiteral、fromStringToLiteral、fromBooleanToLiteral。回顾前面讲述的隐式类的内容，也就是会有相应的隐式转换。以隐式类fromtIntToLiteral为例，存在一个同名的隐式转换，把相应的Scala的Int对象转换成一个fromtIntToLiteral的对象。而fromtIntToLiteral类有两个方法U和S，分别构造一个等值的UInt对象和SInt对象。再加上Scala的基本值类都是用字面量构造对象，所以要表示一个UInt对象，可以写成“1.U”的格式，这样编译器会插入隐式转换，变成“fromtIntToLiteral(1).U”，进而构造出字面值为“1”的UInt对象。同理，<strong>也可以构造SInt。还有相同行为的方法asUInt和asSInt。</strong></p>
<p>​    从几个隐式类的名字就可以看出，可以通过BigInt、Int、Long和String四种类型的Scala字面量来构造UInt和SInt。按Scala的语法，其中BigInt、Int、Long三种类型默认是十进制的，但可以加前缀“0x”或“0X”变成十六进制。对于字符串类型的字面量，Chisel编译器默认也是十进制的，但是可以加上首字母“h”、“o”、“b”来分别表示十六进制、八进制和二进制。此外，字符串字面量可以用下划线间隔。</p>
<p>​    可以通过Boolean类型的字面量——true和false——来构造fromBooleanToLiteral类型的对象，然后调用名为B和asBool的方法进一步构造Bool类型的对象</p>
</blockquote>
<p>以上内容总结为：</p>
<ul>
<li>Chisel定义了一系列隐式类，隐式的从<strong>四种Scala字面量到Chisel数据类型的转变</strong><ul>
<li><strong>隐式类：</strong>fromBigIntToLiteral、fromtIntToLiteral、fromtLongToLiteral、fromStringToLiteral、fromBooleanToLiteral<ul>
<li>隐式类中存在相应的隐式转换方法，同名方法、U方法、S方法，分别把字面量转为：同款隐式类、UInt、SInt</li>
<li>如果要表示一个UInt对象可以写成：<code>1.U</code></li>
</ul>
</li>
<li><strong>四种Scala字面量：</strong>BigInt、Int、Long和String，对应的表示方法：<ul>
<li>BigInt、Int、Long：加前缀0x或0X改变进制</li>
<li>String：首字母“h”、“o”、“b”来分别表示十六进制、八进制和二进制，并可以用下划线间隔</li>
</ul>
</li>
<li>完整形式举例<ul>
<li>表示一个UInt对象可以写成<code>1.U</code>的格式，这样编译器会插入隐式转换，变成<code>fromtIntToLiteral(1).U</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>Scala的Boolean字面量转变方法：</strong><ul>
<li>可以通过Boolean类型的字面量true、false，来构造fromBooleanToLiteral类型的对象</li>
<li>然后<strong>调用名为B</strong>或<strong>asBool的方法</strong>进一步构造Bool类型的对象</li>
</ul>
</li>
</ul>
<p><strong>一些表示数的例子：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-number">1.</span><span class="hljs-type">U</span>                <span class="hljs-comment">// Int字面值为&quot;1&quot;的UInt对象</span><br><span class="hljs-number">0x1</span>.<span class="hljs-type">U</span>		<span class="hljs-comment">//Int字面值为16进制1的UInt对象</span><br><span class="hljs-number">-8.</span><span class="hljs-type">S</span>               <span class="hljs-comment">// Int字面值为&quot;-8&quot;的SInt对象</span><br><br><span class="hljs-string">&quot;b0101&quot;</span>.<span class="hljs-type">U</span>	<span class="hljs-comment">// String字面值为&quot;5&quot;的UInt对象</span><br><br><span class="hljs-literal">true</span>.<span class="hljs-type">B</span>            <span class="hljs-comment">// Boolean字面值为&quot;true&quot;的Bool对象 </span><br></code></pre></div></td></tr></table></figure>
<p><strong>（4）构造没有字面量的对象</strong></p>
<p>UInt、SInt和Bool都不是抽象类，除了可以<strong>通过字面量构造对象</strong>以外，也可以<strong>直接通过apply工厂方法构造没有字面量的对象</strong></p>
<p><strong>有字面量的数据类型</strong>用于赋值、初始化寄存器等操作，而<strong>无字面量的数据类型</strong>则用于声明端口、构造向量等</p>
<h2 id="2-3-数据宽度"><a href="#2-3-数据宽度" class="headerlink" title="2.3 数据宽度"></a>2.3 数据宽度</h2><p><strong>（1）数据的默认宽度：</strong></p>
<p>​    默认情况下，<strong>数据的宽度按字面值取最小</strong>，例如字面值为“8”的UInt对象是4位宽，SInt就是5位宽。但是也可以指定宽度。注意，<strong>Bool类型固定是1位宽</strong>、</p>
<p><strong>（2）宽度类Width、宽度隐式类fromIntToWidth</strong></p>
<p>​    Chisel2里，宽度是由Int类型的参数表示的</p>
<p>​    <strong>Chisel3专门设计了宽度类Width</strong>，还有一个<strong>隐式类fromIntToWidth</strong>（把Int对象转换成fromIntToWidth类型的对象），然后<strong>通过方法W返回一个Width对象</strong>。</p>
<p><strong>（3）如何指定数据宽度：</strong></p>
<p><strong>方法U、asUInt、S和asSInt</strong>都有一个重载的版本，接收一个Width类型的参数，构造指定宽度的SInt和UInt对象</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-number">1.</span><span class="hljs-type">U</span>              <span class="hljs-comment">// 字面值为“1”、宽度为1bit的UInt对象</span><br><br><span class="hljs-number">1.</span><span class="hljs-type">U</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)   <span class="hljs-comment">// 字面值为“1”、宽度为32bit的UInt对象</span><br></code></pre></div></td></tr></table></figure>
<p>也可以直接给定：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-type">UInt</span>(<span class="hljs-string">&quot;ha&quot;</span>, <span class="hljs-number">8</span>) 	<span class="hljs-comment">// hexadecimal 8-bit lit of type UInt </span><br><span class="hljs-type">UInt</span>(<span class="hljs-string">&quot;o12&quot;</span>, <span class="hljs-number">6</span>) 	<span class="hljs-comment">// octal 6-bit lit of type UInt </span><br><span class="hljs-type">UInt</span>(<span class="hljs-string">&quot;b1010&quot;</span>, <span class="hljs-number">12</span>) 	<span class="hljs-comment">// binary 12-bit lit of type UInt</span><br><span class="hljs-type">SInt</span>(<span class="hljs-number">5</span>, <span class="hljs-number">7</span>) 		<span class="hljs-comment">// signed decimal 7-bit lit of type SInt </span><br><span class="hljs-type">UInt</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>) 		<span class="hljs-comment">// unsigned decimal 8-bit lit of type UInt</span><br></code></pre></div></td></tr></table></figure>
<p><strong>（4）UInt、SInt、Bool类中的重载</strong></p>
<p>UInt、SInt和Bool都不是抽象类，除了可以<strong>通过字面量构造对象</strong>以外，也可以<strong>直接通过apply工厂方法构造没有字面量的对象</strong></p>
<p>UInt和SInt的apply方法有两个版本：</p>
<ul>
<li>一个版本接收Width类型的参数构造指定宽度的对象</li>
<li>另一个则是无参版本构造位宽可自动推断的对象</li>
</ul>
<p>有字面量的数据类型用于赋值、初始化寄存器等操作，而无字面量的数据类型则用于声明端口、构造向量等。</p>
<h2 id="2-4-数据类型转换asXXX"><a href="#2-4-数据类型转换asXXX" class="headerlink" title="2.4 数据类型转换asXXX"></a>2.4 数据类型转换asXXX</h2><p>UInt、SInt和Bool三个类都包含四个方法：asUInt、asSInt、toBool和toBools：</p>
<ul>
<li>asUInt和asSInt分别把字面值按无符号数和有符号数解释，并且位宽不会变化，要注意转换过程中可能发生符号位和数值的变化。例如，3bit的UInt值“b111”，其字面量是“7”，转换成SInt后字面量就变成了“-1”</li>
<li>toBool会把1bit的“1”转换成Bool类型的true，“0”转换成false</li>
<li>toBools转换成Bool类型的序列Seq[Bool]，当位宽超过1bit</li>
<li>另外，Bool类还有一个方法asClock，把true转换成电压常高的时钟，false转换成电压常低的时钟。Clock类只有一个方法asUInt，转换成对应的0或1</li>
</ul>
<h2 id="2-5-向量Vec-T"><a href="#2-5-向量Vec-T" class="headerlink" title="2.5 向量Vec[T]"></a>2.5 向量Vec[T]</h2><p>如果需要一个集合类型的数据，除了可以使用Scala内建的数组、列表、集等数据结构外，还可以使用Chisel专属的Vec[T]。T必须是Data的子类，而且每个元素的类型、位宽必须一样。Vec[T]的伴生对象里有一个apply工厂方法，接收两个参数，第一个是Int类型，表示元素的个数，第二个是元素。它属于可索引的序列，下标从0开始</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> myVec = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">3</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)))<br><span class="hljs-keyword">val</span> myReg = myVec(<span class="hljs-number">0</span>)<br></code></pre></div></td></tr></table></figure>
<p><strong>还有一个工厂方法VecInit[T]</strong>：</p>
<ul>
<li><p>接收参数为<strong>一个Seq[T]</strong>或者是<strong>多个重复参数</strong>来构造向量，且常有有<strong>字面值的数据作为参数</strong>，<strong>用于初始化寄存器组、ROM、RAM等，或者用来构造多个模块</strong></p>
</li>
<li><p><img src="2022-3-9-chisel/image-20220313172534854.png" srcset="/img/loading.gif" lazyload alt="image-20220313172534854"><a target="_blank" rel="noopener" href="https://www.chisel-lang.org/api/3.3.3/chisel3/VecInit$.html">官网api解释</a></p>
</li>
</ul>
<p><strong>因为Vec[T]也是一种Seq</strong></p>
<ul>
<li><p>使用VecInit的工厂方法可以把Seq类型转为Vec[T]如上图</p>
</li>
<li><p>Vec[T]定义了诸如map、flatMap、zip、foreach、filter、exists、contains等方法。尽管这些方法应该出现在软件里，但是它们也可以简化硬件逻辑的编写，减少手工代码量。</p>
</li>
</ul>
<h2 id="2-6-混合向量MixedVec-T"><a href="#2-6-混合向量MixedVec-T" class="headerlink" title="2.6 混合向量MixedVec[T]"></a>2.6 混合向量MixedVec[T]</h2><p>混合向量MixedVec[T]与普通的向量Vec[T]类似，只不过包含的元素可以不全都一样。它的工厂方法是通过重复参数或者序列作为参数来构造的，并且也有一个叫MixedVecInit[T]的单例对象。</p>
<p>对于构造Vec[T]和MixedVec[T]的序列，并<strong>不一定要逐个手写，可以通过Scala的函数，比如fill、map、flatMap、to、until等来生成。</strong>例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> mixVec = <span class="hljs-type">Wire</span>(<span class="hljs-type">MixedVec</span>((<span class="hljs-number">1</span> to <span class="hljs-number">10</span>) map &#123; i =&gt; <span class="hljs-type">UInt</span>(i.<span class="hljs-type">W</span>) &#125;))<br></code></pre></div></td></tr></table></figure>
<h2 id="2-7-包裹Bundle"><a href="#2-7-包裹Bundle" class="headerlink" title="2.7 包裹Bundle"></a>2.7 包裹Bundle</h2><p><strong>抽象类Bundle很像C语言的结构体(struct)</strong>，用户可以编写一个自定义类来继承自它，然后在自定义的类里包含其它各种Data类型的字段。它可以协助构建线网或寄存器，但是<strong>最常见的用途是用于构建一个模块的端口列表，或者一部分端口</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">//new Bundle&#123;...&#125;定义并例化了一个继承于Bundle的匿名子类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>       <span class="hljs-keyword">val</span> in = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>       <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>   &#125;)<br>  <br> <span class="hljs-comment">//直接定义了一个Bundle的子类</span><br> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBundle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> foo = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 高位</span><br>   <span class="hljs-keyword">val</span> bar = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 低位</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>（2）Bundle和UInt转换</strong></p>
<p><strong>Bundle-&gt;UInt：</strong>Bundle可以和UInt进行相互转换。Bundle类有一个方法asUInt，可以把所含的字段拼接成一个UInt数据，并且前面的字段在高位</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBundle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> foo = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 高位</span><br>   <span class="hljs-keyword">val</span> bar = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 低位</span><br>&#125;<br><br><span class="hljs-keyword">val</span> bundle = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyBundle</span>)<br>bundle.foo := <span class="hljs-number">0xc</span>.<span class="hljs-type">U</span><br>bundle.bar := <span class="hljs-number">0x3</span>.<span class="hljs-type">U</span><br><span class="hljs-keyword">val</span> uint = bundle.asUInt  <span class="hljs-comment">// 12*16 + 3 = 195</span><br></code></pre></div></td></tr></table></figure>
<p><strong>Data-&gt;Bundle：</strong>有一个隐式类fromBitsable，可以把Data类型的对象转化成该类型，然后通过方法fromBits来接收一个Bits类型的参数来给该对象赋值。不过，该方法在Chisel3中已经被标注为过时，不推荐使用。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBundle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> foo = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 高位</span><br>   <span class="hljs-keyword">val</span> bar = <span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>)  <span class="hljs-comment">// 低位</span><br>&#125;<br><br><span class="hljs-keyword">val</span> uint = <span class="hljs-number">0xb4</span>.<span class="hljs-type">U</span><br><span class="hljs-keyword">val</span> bundle = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyBundle</span>).fromBits(uint)  <span class="hljs-comment">// foo = 11, bar = 4</span><br></code></pre></div></td></tr></table></figure>
<h2 id="2-8-Chisel的内建操作符"><a href="#2-8-Chisel的内建操作符" class="headerlink" title="2.8 Chisel的内建操作符"></a>2.8 Chisel的内建操作符</h2><p>有了数据类型，还需要预定义一些相关的操作符进行基本的操作。下表是Chisel内建的操作符：</p>
<table align="center" border="1" cellpadding="1" cellspacing="1" style="width:557px;"><div style="text-align:center;">Chisel的内建操作符</div><caption>
  Chisel的内建操作符
 </caption><thead><tr><th style="text-align:center;vertical-align:middle;width:268px;">操作符</th><th style="text-align:center;vertical-align:middle;width:286px;">释义</th></tr></thead><tbody><tr><th style="text-align:center;vertical-align:middle;width:268px;">位操作符</th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt, Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val invertedX = ~x</td><td style="text-align:center;vertical-align:middle;width:286px;">位取反</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val hiBits = x &amp; "h_ffff_0000".U</td><td style="text-align:center;vertical-align:middle;width:286px;">位与</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val flagsOut = flagsIn | overflow</td><td style="text-align:center;vertical-align:middle;width:286px;">位或</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val flagsOut = flagsIn ^ toggle</td><td style="text-align:center;vertical-align:middle;width:286px;">位异或</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>缩减位操作符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt&nbsp; 返回类型: Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val allSet = x.andR</td><td style="text-align:center;vertical-align:middle;width:286px;">缩减与</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val anySet = x.orR</td><td style="text-align:center;vertical-align:middle;width:286px;">缩减或</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val parity = x.xorR</td><td style="text-align:center;vertical-align:middle;width:286px;">缩减异或</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>相等性比较符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt, Bool </strong>&nbsp;<strong>返回类型: Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val equ = x === y</td><td style="text-align:center;vertical-align:middle;width:286px;">相等</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val neq = x =/= y</td><td style="text-align:center;vertical-align:middle;width:286px;">不相等</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>移位操作符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val twoToTheX = 1.S &lt;&lt; x</td><td style="text-align:center;vertical-align:middle;width:286px;">逻辑左移</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val hiBits = 16.U &gt;&gt; x</td><td style="text-align:center;vertical-align:middle;width:286px;">右移(UInt逻辑右移，SInt算术右移)</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>部分位操作符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt, Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val xLSB = x(0)</td><td style="text-align:center;vertical-align:middle;width:286px;">抽取1bit，最低位下标0，最高位下标n-1</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val xTopNibble = x(15, 12)</td><td style="text-align:center;vertical-align:middle;width:286px;">抽取多个bit，左边是高位，右边是低位</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val usDebt = Fill(3, "hA".U)</td><td style="text-align:center;vertical-align:middle;width:286px;">拼接一个UInt类型的数据多次(位于util包)</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val float = Cat(sign, exponent, mantissa)</td><td style="text-align:center;vertical-align:middle;width:286px;">拼接多个bit，左边的参数是高位(位于util包)</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>逻辑操作符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val sleep = !busy</td><td style="text-align:center;vertical-align:middle;width:286px;">逻辑非</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val hit = tagMatch &amp;&amp; valid</td><td style="text-align:center;vertical-align:middle;width:286px;">逻辑与</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val stall = src1busy || src2busy</td><td style="text-align:center;vertical-align:middle;width:286px;">逻辑或</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val out = Mux(sel, inTrue, inFalse)</td><td style="text-align:center;vertical-align:middle;width:286px;">双输入多路选择器，sel是Bool类型</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>算术操作符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val sum = a + b&nbsp;&nbsp;<em>or</em>&nbsp; val sum = a +% b</td><td style="text-align:center;vertical-align:middle;width:286px;">加法(不进行宽度扩展)</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val sum = a +&amp; b</td><td style="text-align:center;vertical-align:middle;width:286px;">加法(扩展一位进位位)</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val diff = a - b&nbsp;&nbsp;<em>or</em>&nbsp; val diff = a -% b</td><td style="text-align:center;vertical-align:middle;width:286px;">减法(不进行宽度扩展)</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val diff = a -&amp; b</td><td style="text-align:center;vertical-align:middle;width:286px;">减法(扩展一位进位位)</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val prod = a * b</td><td style="text-align:center;vertical-align:middle;width:286px;">乘法</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val div = a / b</td><td style="text-align:center;vertical-align:middle;width:286px;">除法</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val mod = a % b</td><td style="text-align:center;vertical-align:middle;width:286px;">求余数</td></tr><tr><th style="text-align:center;vertical-align:middle;width:268px;"><strong>算术比较符</strong></th><th style="text-align:center;vertical-align:middle;width:286px;"><strong>作用类型: </strong><strong>SInt, UInt </strong>&nbsp;<strong>返回类型: Bool</strong></th></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val gt = a &gt; b</td><td style="text-align:center;vertical-align:middle;width:286px;">大于</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val gte = a &gt;= b</td><td style="text-align:center;vertical-align:middle;width:286px;">大于等于</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val lt = a &lt; b</td><td style="text-align:center;vertical-align:middle;width:286px;">小于</td></tr><tr><td style="text-align:center;vertical-align:middle;width:268px;">val lte = a &lt;= b</td><td style="text-align:center;vertical-align:middle;width:286px;">小于等于</td></tr></tbody></table>


<p>这里要注意的一点是相等性比较的两个符号是<mark>“===”和“=/=”</mark>，因为“==”和“!=”已经被Scala占用，所以Chisel另设了这两个新的操作符。按照优先级的判断准则，<strong>“===”和“=/=”的优先级</strong>以首个字符为“=”来判断，也就是在逻辑操作中，相等性比较的优先级要比与、或、异或都高。</p>
<h2 id="2-9-位宽推断"><a href="#2-9-位宽推断" class="headerlink" title="2.9 位宽推断"></a>2.9 位宽推断</h2><p>用户需要设置端口和寄存器的位宽，除非用户手动设置，否则编译器会自动推测wire上的位宽。位宽推测引擎会从节点图的输入端口开始，并根据以下规则集从它们各自的输入位宽度计算节点输出位宽度：</p>
<table align="center" border="1" cellpadding="1" cellspacing="1" style="width:500px;"><b><div style="text-align:center;">Chisel的位宽判断</div></b><thead><tr><th style="text-align:center;vertical-align:middle;"><strong>操作符</strong></th><th style="text-align:center;vertical-align:middle;">位宽</th></tr></thead><tbody><tr><td style="text-align:center;vertical-align:middle;">z = x + y&nbsp;&nbsp;<em>or</em>&nbsp; z = x +% y</td><td style="text-align:center;vertical-align:middle;">w(z) = max(w(x), w(y))</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x +&amp; y</td><td style="text-align:center;vertical-align:middle;">w(z) = max(w(x), w(y)) + 1</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x - y&nbsp;<em>or</em>&nbsp;z = x -% y</td><td style="text-align:center;vertical-align:middle;">w(z) = max(w(x), w(y))</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x -&amp; y</td><td style="text-align:center;vertical-align:middle;">w(z) = max(w(x), w(y)) + 1</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x &amp; y</td><td style="text-align:center;vertical-align:middle;">w(z) = min(w(x), w(y))</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = Mux(c, x, y)</td><td style="text-align:center;vertical-align:middle;">w(z) = max(w(x), w(y))</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = w * y</td><td style="text-align:center;vertical-align:middle;">w(z) = w(x) + w(y)</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x &lt;&lt; n</td><td style="text-align:center;vertical-align:middle;">w(z) = w(x) + maxNum(n)</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = x &gt;&gt; n</td><td style="text-align:center;vertical-align:middle;">w(z) = w(x) - minNum(n)</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = Cat(x, y)</td><td style="text-align:center;vertical-align:middle;">w(z) = w(x) + w(y)</td></tr><tr><td style="text-align:center;vertical-align:middle;">z = Fill(n, x)</td><td style="text-align:center;vertical-align:middle;">w(z) = w(x) * maxNum(n)</td></tr></tbody></table>

<p>​    其中例如wz是wire z的位宽，＆规则可应用于所有按位逻辑运算</p>
<p><strong>位宽推测过程：</strong></p>
<p>​    位宽推测过程会持续到没有位宽改变。 除了通过已知固定数量的右移之外，位宽推测规定了输出位宽度不能小于输入位宽度，因此输出位宽度增长或保持相同。 此外，寄存器的宽度必须由用户明确地或根据复位值或下一个参数的位宽指定。根据这两个要求，我们可以将位宽推测过程将收敛到一个固定点。</p>
<p><strong>有关自动截断的问题：</strong></p>
<p>​    当把一个短位宽的信号值或硬件结构赋值给长位宽的硬件结构时，会自动扩展符号位。但是反过来会报错，并不是像Verilog那样把多余的高位截断，这需要注意(注：最新的chisel3版本已经可以像Verilog一样自动把高位截断了)</p>
<h1 id="3-硬件类型"><a href="#3-硬件类型" class="headerlink" title="3 硬件类型"></a>3 硬件类型</h1><p>本章将介绍<strong>Chisel里的常用硬件类型、控制语句、如何编写一个基本的模块</strong>，对于高级类型，读者可以自行研究。常用的硬件类型包括：</p>
<ul>
<li>IO</li>
<li>Module</li>
<li>Wire</li>
<li>Reg</li>
</ul>
<p><strong>关于数据类型和硬件类型的关系可参考3.8总结中的内容</strong></p>
<h3 id="3-0-Verilog与Chisel中的硬件类型"><a href="#3-0-Verilog与Chisel中的硬件类型" class="headerlink" title="3.0 Verilog与Chisel中的硬件类型"></a>3.0 Verilog与Chisel中的硬件类型</h3><p>Chisel在构建硬件的思路上类似Verilog。在Verilog中，是以“模块(module)”为基本单位组成一个完整的独立功能实体，所以Chisel也是按模块划分的，只不过不是用关键字“module”开头来定义模块，而是<strong>Chisel定义模块用一个继承自Module类的自定义class</strong></p>
<p><strong>Verilog与Chisel中的硬件类型：</strong></p>
<ul>
<li><p>在Verilog里，模块内部主要有“线网(wire)”和“四态变量(reg)”两种硬件类型，它们用于描述数字电路的组合逻辑和时序逻辑。</p>
</li>
<li><p>在Chisel里，也按这个思路定义了一些硬件类型，<strong>包括基本的线网和寄存器，以及一些常用的其它类型</strong>。前一章介绍了Chisel的数据类型，这还不够，因为这些数据类型是无法独立工作的。实际的电路应该是由硬件类型的对象构成的，不管是信号的声明，还是用赋值进行信号传递，都是由硬件类型的对象来完成的。<strong>数据类型和硬件类型融合在一起，才能构成完整、可运行的组件。</strong>比如要声明一个线网，这部分工作由硬件类型来完成；这个线网的位宽是多少、按无符号数还是有符号数解释、是不是向量等等，这些则是由作为参数的数据类型对象来定义的。</p>
</li>
</ul>
<h2 id="3-1-val与赋值"><a href="#3-1-val与赋值" class="headerlink" title="3.1 val与赋值"></a>3.1 val与赋值</h2><p>有了硬件类型后，就可以用赋值操作来进行信号的传递或者电路的连接。只有硬件赋值才有意义，单纯的数据对象进行赋值并不会被编译器转换成实际的电路，因为在Verilog里也是对wire、reg类型的硬件进行赋值。那么，赋值操作需要什么样的操作符来完成呢？</p>
<p><strong>在Chisel里，所有对象都应该由val类型的变量来引用，因为硬件电路的不可变性</strong>，因此具有以下两种情况：</p>
<ul>
<li><p><strong>硬件电路绑定val后不可变：</strong>一个变量一旦初始化时绑定了一个对象，就不能再发生更改</p>
</li>
<li><p><strong>对引用对象赋值(驱动)时可变：</strong>但引用的对象，很可能需要被重新赋值。例如，输出端口在定义时使用了“=”与端口变量名进行了绑定，那等到驱动该端口时，就需要通过变量名来进行赋值操作，更新数据。很显然，此时“=”已经不可用了，因为变量在声明的时候不是var类型。即使是var类型，这也只是让变量引用新的对象，而不是直接更新原来的可变对象。</p>
</li>
</ul>
<p><strong>如何对引用对象赋值：</strong></p>
<p>​    为了解决这个问题，<strong>几乎所有的Chisel类都定义了方法<code>:=</code></strong>，<strong>作为等号赋值的代替</strong>。所以首次创建变量时用等号初始化，如果变量引用的对象不能立即确定状态或本身就是可变对象，则在后续更新状态时应该用“:=”。从前面讲的操作符优先级来判断，该操作符以等号结尾，而且不是四种逻辑比较符号之一，所以优先级与等号一致，是最低的。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> x = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br><br><span class="hljs-keyword">val</span> y = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br><br>x := <span class="hljs-string">&quot;b1010&quot;</span>.<span class="hljs-type">U</span>  <span class="hljs-comment">// 驱动4bit的线网x为无符号数10</span><br><br>y := ~x  <span class="hljs-comment">// 驱动线网y为x的按位取反</span><br></code></pre></div></td></tr></table></figure>
<h2 id="3-2-端口、自定义接口、模块接口"><a href="#3-2-端口、自定义接口、模块接口" class="headerlink" title="3.2 端口、自定义接口、模块接口"></a>3.2 端口、自定义接口、模块接口</h2><h3 id="3-2-1-定义"><a href="#3-2-1-定义" class="headerlink" title="3.2.1 定义"></a>3.2.1 定义</h3><p><strong>定义：</strong></p>
<ul>
<li>端口：任何为其成员分配了方向的<strong>数据对象</strong></li>
<li>自定义端口列表：Bundle的子类</li>
<li>模块接口：Module中的io字段，指向一个IO实例实例</li>
</ul>
<p><strong>各种类型实现概览：</strong></p>
<ul>
<li><p><strong>端口</strong>/有方向的数据对象：端口类的原始声明为<code>Input[T &lt;: Data](source: T)</code>和<code>Output[T &lt;: Data](source: T)</code>。<strong>注意</strong>，端口复制源数据对象的参数，不能是已经被硬件类型包裹的数据类型。目前Chisel还<strong>不支持双向端口inout</strong>，只能通过黑盒里的Analog端口来模拟外部Verilog的双向端口。</p>
</li>
<li><p><strong>自定义端口列表</strong>/Bundle子类：自定义类，<strong>父类</strong>或<strong>超类(自定义接口的子类)</strong>是Bundle，内部嵌入了分配方向的数据对象</p>
</li>
<li><p><strong>模块接口</strong>/io字段：指向一个IO实例，IO类的原始声明为<code>IO[T &lt;: Data](iodef: T)</code></p>
</li>
</ul>
<h3 id="3-2-2-如何声明一个自定义的端口列表"><a href="#3-2-2-如何声明一个自定义的端口列表" class="headerlink" title="3.2.2 如何声明一个自定义的端口列表"></a>3.2.2 如何声明一个自定义的端口列表</h3><h4 id="（1）定义Bundle的子类"><a href="#（1）定义Bundle的子类" class="headerlink" title="（1）定义Bundle的子类"></a>（1）定义Bundle的子类</h4><p>Bundle类作为<strong>父类</strong>，定义子类完成</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">//一个声明端口的例子</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Decoupled</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>    <span class="hljs-keyword">val</span> ready = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> data = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> valid = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>也可以是Bundle作为<strong>超类</strong>，扩展子类</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleLink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br><span class="hljs-keyword">val</span> data = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">16.</span><span class="hljs-type">W</span>))<br><span class="hljs-keyword">val</span> valid = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())<br>&#125;<br><span class="hljs-comment">//我们可以通过使用bundle继承添加奇偶校验位来扩展SimpleLink</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PLink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleLink</span> </span>&#123;<br><span class="hljs-keyword">val</span> parity = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>))<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="（2）端口列表的嵌套"><a href="#（2）端口列表的嵌套" class="headerlink" title="（2）端口列表的嵌套"></a>（2）端口列表的嵌套</h4><p><strong>端口列表嵌套单个端口列表：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilterIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-comment">//在一个新的 FilterIO 包中嵌套两个 pliks 来定义一个过滤器接口:</span><br>  <span class="hljs-keyword">val</span> x = <span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span>)<span class="hljs-comment">//反转的PLink实例</span><br>  <span class="hljs-keyword">val</span> y = <span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span><span class="hljs-comment">//PLink实例</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>端口列表嵌套端口列表向量<a target="_blank" rel="noopener" href="https://www.chisel-lang.org/chisel3/docs/explanations/interfaces-and-connections.html">Bundle Vec</a>：</strong></p>
<p>通过Vec构造函数，在端口列表中，嵌套端口列表向量形成了更丰富的层次结构接口。</p>
<p>为了创建一个被Uint输入选择的有多组向量输入输出的mux，我们使用了Vec构造方法(For example, in order to create a crossbar with a vector of inputs, producing a vector of outputs, and selected by a UInt input, we utilize the Vec constructor:)</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> chisel3.util.log2Ceil<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CrossbarIo</span>(<span class="hljs-params">n: <span class="hljs-type">Int</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> in = <span class="hljs-type">Vec</span>(n, <span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span>))<br>  <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(log2Ceil(n).<span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> out = <span class="hljs-type">Vec</span>(n, <span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span>)<br>  <span class="hljs-comment">// Vec 以 size 作为第一个参数，以返回端口的块作为第二个参数。</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="3-2-3-如何定义端口"><a href="#3-2-3-如何定义端口" class="headerlink" title="3.2.3 如何定义端口"></a>3.2.3 如何定义端口</h3><p><strong>如何定义端口：</strong>使用两个构造函数</p>
<ul>
<li><code>Input[T &lt;: Data](source: T)</code></li>
<li><code>Output[T &lt;: Data](source: T)</code></li>
</ul>
<p><strong>两种定义端口的示例：</strong></p>
<ul>
<li><strong>声明时指定方向</strong></li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Decoupled</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br><span class="hljs-keyword">val</span> ready = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())<br><span class="hljs-keyword">val</span> data = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br><span class="hljs-keyword">val</span> valid = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>&#125;<br></code></pre></div></td></tr></table></figure>
<ul>
<li><strong>实例化时指定方向</strong></li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScaleIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>    <span class="hljs-keyword">val</span> in = <span class="hljs-keyword">new</span> <span class="hljs-type">MyFloat</span>().asInput<br>    <span class="hljs-keyword">val</span> scale = <span class="hljs-keyword">new</span> <span class="hljs-type">MyFloat</span>().asInput<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-keyword">new</span> <span class="hljs-type">MyFloat</span>().asOutput<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>​    <code>asInput</code>和<code>asOutput</code>方法强制<strong>数据对象的所有模块</strong>指向所请求的方向</p>
<p><strong>端口的特性：</strong></p>
<ul>
<li>驱动特性：<strong>端口输入可以驱动内部其它信号，输出可以被其他信号驱动</strong>。</li>
<li>赋值特性：<strong>端口可以直接进行赋值操作</strong>，布尔类型的端口还能直接作为使能信号。</li>
<li>硬件类型：<strong>端口不需要再使用其它硬件类型来定义</strong>，不过要注意从性质上来说它仍然属于组合逻辑的线网</li>
</ul>
<h3 id="3-2-4-模块接口"><a href="#3-2-4-模块接口" class="headerlink" title="3.2.4 模块接口"></a>3.2.4 模块接口</h3><p><strong>定义：</strong>模块接口是模块中固定字段io</p>
<p><strong>固定字段io：</strong></p>
<ul>
<li><strong>io名称固定</strong>，是Module类的内部成员</li>
<li>io指向了一个自定义接口实例，实例由<strong>方法<code>IO[T &lt;: Data](iodef: T)</code>生成</strong></li>
</ul>
<p><strong>通过io调用端口：</strong>一旦模块接口定义完成，就可以通过<code>io.端口x</code>使用</p>
<p><strong>模块接口示例：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">//声明一个端口类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> in = <span class="hljs-type">Input</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">5</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)))<br>   <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>&#125;<br><br>......<br> <span class="hljs-comment">// 模块的端口列表</span><br>   <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyIO</span>) <br>......<br></code></pre></div></td></tr></table></figure>
<h3 id="3-2-5-翻转端口列表的方向"><a href="#3-2-5-翻转端口列表的方向" class="headerlink" title="3.2.5 翻转端口列表的方向"></a>3.2.5 翻转<u>端口列表</u>的方向</h3><ul>
<li>方法“<code>Flipped[T &lt;: Data](source: T)</code>方法</li>
<li>对于两个相连的模块，可能存在大量同名但方向相反的端口。仅仅为了翻转方向而不得不重写一遍端口显得费时费力，所以Chisel提供了“<code>Flipped[T &lt;: Data](source: T)</code>方法，可以把参数里所有的输入转输出，输出转输入。如果是黑盒里的Analog端口，则仍是双向的。例如：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>   <span class="hljs-keyword">val</span> in = <span class="hljs-type">Input</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">5</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)))<br>   <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>&#125;<br><br>......<br>   <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyIO</span>)  <span class="hljs-comment">// in是输入，out是输出</span><br>......<br>   <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyIO</span>))  <span class="hljs-comment">// out是输入，in是输出</span><br></code></pre></div></td></tr></table></figure>
<h3 id="3-2-6-端口的两种连接方式"><a href="#3-2-6-端口的两种连接方式" class="headerlink" title="3.2.6 端口的两种连接方式"></a>3.2.6 端口的两种连接方式</h3><p>一旦我们定义了接口，我们就可以通过如下操作符进行连接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.chisel-lang.org/api/latest/chisel3/Data.html#:="><code>MonoConnect</code></a>操作符 ( <code>:=</code>) </li>
<li><a target="_blank" rel="noopener" href="https://www.chisel-lang.org/api/latest/chisel3/Data.html#&lt;"><code>BiConnect</code></a>操作符 ( <code>&lt;&gt;</code>) </li>
</ul>
<p><strong>（1）<code>MonoConnect.connect</code>, 或<code>:=</code>, 按元素执行单向连接。\</strong></p>
<p>请注意，这不是可交换的。在调用这个函数之前，已经确定了一个显式的source和sink</p>
<p>连接操作将在左数据中递归(使用右数据)。如果通过左侧的移动不能与右侧的移动相匹配，则将引发异常。右侧允许有额外的字段。Vec内部元素必须仍然是完全相同的大小</p>
<p><strong>:=的左值与右值：</strong></p>
<ul>
<li><p>左值必须是可写的，因此其中之一必须保持：</p>
<ul>
<li><p>是内部可写节点（<code>Reg</code>或<code>Wire</code>）</p>
</li>
<li><p>是当前模块的输出</p>
</li>
<li><p>是当前模块的子模块的输入</p>
</li>
</ul>
</li>
<li><p>右值必须是可读的，因此其中之一必须保持：</p>
<ul>
<li><p>是内部可读节点 ( <code>Reg</code>, <code>Wire</code>, <code>Op</code>)</p>
</li>
<li><p>是字面的</p>
</li>
<li><p>是当前模块的端口还是当前模块的子模块</p>
</li>
</ul>
</li>
</ul>
<p><strong>（2）<code>BiConnect.connect</code>, 或<code>&lt;&gt;</code>, 按元素执行双向连接</strong></p>
<p>请注意，参数是左和右（不是源和接收器），因此目的是使操作具有可交换性。连接操作将递归左下<code>Data</code>（右<code>Data</code>）。如果左侧的移动无法在右侧匹配，或者右侧有额外的字段，则会引发异常</p>
<p><strong>biconnect<code>&lt;&gt;</code>运算符的用法：</strong></p>
<ul>
<li>将两个模块组合成一个过滤器块，如下所示：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleLink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> data = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">16.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> valid = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PLink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleLink</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> parity = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>))<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilterIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> x = <span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span>)<br>  <span class="hljs-keyword">val</span> y = <span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Filter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br>  <span class="hljs-keyword">val</span> f1 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Filter</span>)<br>  <span class="hljs-keyword">val</span> f2 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Filter</span>)<br>  f1.io.x &lt;&gt; io.x<br>  f1.io.y &lt;&gt; f2.io.x<br>  f2.io.y &lt;&gt; io.y<br>&#125;<br></code></pre></div></td></tr></table></figure>
<ul>
<li><strong>连接同名的子端口时</strong>，对Bundle 的 Scala 类型不需要匹配。如果任一侧缺少一个命名信号，Chisel 将给出错误，如下例所示：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotReallyAFilterIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> x = <span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span>)<br>  <span class="hljs-keyword">val</span> y = <span class="hljs-keyword">new</span> <span class="hljs-type">PLink</span><br>  <span class="hljs-keyword">val</span> z = <span class="hljs-type">Output</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bool</span>())<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io1 = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br>  <span class="hljs-keyword">val</span> io2 = <span class="hljs-type">IO</span>(<span class="hljs-type">Flipped</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">NotReallyAFilterIO</span>))<br><br>  io1 &lt;&gt; io2<br>&#125;<br><br><span class="hljs-comment">//执行</span><br><span class="hljs-type">ChiselStage</span>.emitVerilog(<span class="hljs-keyword">new</span> <span class="hljs-type">Block2</span>)<br><span class="hljs-comment">//执行后发生错误，错误提示如下：</span><br><span class="hljs-comment">// chisel3.internal.ChiselException: Connection between left (Block2.io1: IO[FilterIO]) ...</span><br></code></pre></div></td></tr></table></figure>
<p><strong>注意事项：</strong></p>
<ul>
<li>双向连接只能与<strong>定向元素</strong>（如 IO）一起使用，例如不支持连接两条线，因为 Chisel 不一定能自动确定方向。例如，在此处放置两条临时电线并将它们连接起来是行不通的，即使可以从端点知道方向：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockWithTemporaryWires</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br>  <span class="hljs-keyword">val</span> f1 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Filter</span>)<br>  <span class="hljs-keyword">val</span> f2 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Filter</span>)<br>  f1.io.x &lt;&gt; io.x<br> <span class="hljs-keyword">val</span> tmp1 = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br> <span class="hljs-keyword">val</span> tmp2 = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FilterIO</span>)<br>  f1.io.y &lt;&gt; tmp1<br>  tmp1 &lt;&gt; tmp2<br>  tmp2 &lt;&gt; f2.io.x<br>  f2.io.y &lt;&gt; io.y<br>&#125;<br><br><span class="hljs-comment">//执行</span><br><span class="hljs-type">ChiselStage</span>.emitVerilog(<span class="hljs-keyword">new</span> <span class="hljs-type">BlockWithTemporaryWires</span>)<br><span class="hljs-comment">//执行后发生错误，错误结果提示：</span><br><span class="hljs-comment">// chisel3.internal.ChiselException: Connection between left (Filter.io.y: IO[PLink]) ...</span><br></code></pre></div></td></tr></table></figure>
<p>有关更多详细信息和信息，请参阅<a target="_blank" rel="noopener" href="https://www.chisel-lang.org/chisel3/docs/explanations/connection-operators.md">深入了解连接运算符</a></p>
<p><strong>注意：当使用<code>Chisel._</code>(兼容模式) 而不是 时<code>chisel3._</code>，<code>:=</code>运算符以类似于 的双向方式工作<code>&lt;&gt;</code>，但不完全相同。</strong></p>
<h2 id="3-3-模块"><a href="#3-3-模块" class="headerlink" title="3.3 模块"></a>3.3 模块</h2><h3 id="3-3-1-模块的特性"><a href="#3-3-1-模块的特性" class="headerlink" title="3.3.1 模块的特性"></a>3.3.1 模块的特性</h3><p>在Chisel里面是用一个自定义的类来定义模块的，这个类有以下三个特点：</p>
<ul>
<li><p><strong>继承自Module类</strong>。</p>
</li>
<li><p>有一个<strong>抽象字段<code>io</code>需要实现</strong>，该字段必须引用前面所说的端口对象。</p>
</li>
<li><p>在类的<strong>主构造器里进行内部电路连线</strong>。因为非字段、非方法的内容都属于主构造方法，<strong>所以用操作符“:=”进行的赋值、用“&lt;&gt;”进行的连线或一些控制结构等等</strong>，都属于主构造方法。</p>
<ul>
<li><blockquote>
<p>从Scala的层面来讲，这些代码在实例化时表示如何构造一个对象；</p>
<p>从Chisel的层面来讲，它们就是在声明如何进行模块内部子电路的连接、信号的传递，类似于Verilog的assign和always语句。实际上这些用赋值表示的电路连接在转换成Verilog时，组合逻辑就是大量的assign语句，时序逻辑就是always语句</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><strong>自定义类所继承Module类的两个字段clock、reset：</strong></p>
<ul>
<li>clock类型是Clock，它表示<strong>全局时钟</strong>，在整个模块内都可见。对于组合逻辑，是用不上它的，而时序逻辑虽然需要这个时钟，但也不用显式声明。</li>
<li>reset类型是Reset，表示<strong>全局复位信号</strong>，在整个模块内可见。对于需要复位的时序元件，也可以不用显式使用该字段。如果确实需要用到全局时钟和复位，则可以通过它们的字段名称来使用，但要注意类型是否匹配，经常需要“reset.toBool”这样的语句把Reset类型转换成Bool类型用于控制。隐式的全局时钟和复位端口只有在生成Verilog代码时才能看到。</li>
</ul>
<p><strong>要编写一个双输入多路选择器，其代码如下所示：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// mux2.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mux2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>    <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in0 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><br>  io.out := (io.sel &amp; io.in1) | (~io.sel &amp; io.in0)<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p>在这里，“new Bundle { … }”的写法是声明一个匿名类继承自Bundle，然后实例化匿名类。对于短小、简单的端口列表，可以使用这种简便写法。对于大的公用接口，应该单独写成具名的Bundle子类，方便修改。“io.out := …”其实就是主构造方法的一部分，通过内建操作符和三个输入端口，实现了输出端口的逻辑行为</p>
</blockquote>
<h3 id="3-3-2-例化模块"><a href="#3-3-2-例化模块" class="headerlink" title="3.3.2 例化模块"></a>3.3.2 例化模块</h3><p><strong>例化模块包括两个步骤：</strong></p>
<ul>
<li>用new生成一个实例对象就完成了<ul>
<li><code>new 自定义模块类</code></li>
</ul>
</li>
<li><strong>还需要再把实例的对象传递给单例对象Module的apply方法</strong><ul>
<li><code>Module(自定义模块对象实例)</code></li>
</ul>
</li>
</ul>
<p>​    这种别扭的语法是Scala的语法限制造成的，就像端口需要写成<code>IO(new Bundle &#123;...&#125;)</code>，无符号数要写成<code>UInt(n.W)</code>等等一样。</p>
<p>例如，下面的代码通过例化刚才的双输入多路选择器构建四输入多路选择器：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// mux4.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mux4</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> in0 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in2 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in3 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">2.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br>  <span class="hljs-keyword">val</span> m0 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Mux2</span>)<br>  m0.io.sel := io.sel(<span class="hljs-number">0</span>)<br>  m0.io.in0 := io.in0<br>  m0.io.in1 := io.in1<br>  <span class="hljs-keyword">val</span> m1 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Mux2</span>)<br>  m1.io.sel := io.sel(<span class="hljs-number">0</span>)<br>  m1.io.in0 := io.in2<br>  m1.io.in1 := io.in3<br>  <span class="hljs-keyword">val</span> m2 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Mux2</span>)<br>  m2.io.sel := io.sel(<span class="hljs-number">1</span>)<br>  m2.io.in0 := m0.io.out<br>  m2.io.in1 := m1.io.out<br>  io.out := m2.io.out<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="3-3-3-一次性例化多个模块"><a href="#3-3-3-一次性例化多个模块" class="headerlink" title="3.3.3 一次性例化多个模块"></a>3.3.3 一次性例化多个模块</h3><p>像上个例子中，模块Mux2例化了三次，实际只需要一次性例化三个模块就可以了</p>
<p><strong>例化多个模块的原理</strong>：</p>
<ul>
<li>通过向量的工厂方法<a target="_blank" rel="noopener" href="https://www.chisel-lang.org/api/3.3.3/chisel3/VecInit$.html"><code>VecInit[T &lt;: Data]</code></a>进行多个模块接口的例化</li>
<li><code>VecInit</code>的apply方法的参数<ul>
<li>使用序列作为参数（用的多）<ul>
<li>使用单例对象Seq里的方法fill进行构造，把多个模块接口整合到序列中</li>
</ul>
</li>
<li>使用重复参数（用的少）</li>
</ul>
</li>
</ul>
<blockquote>
<p>对于要多次例化的重复模块，可以利用向量的工厂方法VecInit[T &lt;: Data]。因为该方法接收的参数类型是Data的子类，而模块的字段io正好是Bundle类型，并且实际的电路连线仅仅只需针对模块的端口，所以可以把待例化模块的io字段组成一个序列，或者按重复参数的方式作为参数传递。</p>
<p>通常使用序列作为参数，这样更节省代码。生成序列的一种方法是调用单例对象Seq里的方法fill，该方法的一个重载版本有两个单参数列表，第一个接收Int类型的对象，表示序列的元素个数，第二个是传名参数，接收序列的元素。</p>
</blockquote>
<p><strong>注意：</strong></p>
<ul>
<li><strong>Vec元素是模块接口字段，因此无需经过io引用，并且可直接通过下表索引</strong></li>
</ul>
<blockquote>
<p>因为Vec是一种可索引的序列，所以这种方式例化的多个模块类似于“模块数组”，用下标索引第n个模块。</p>
<p>因为Vec的元素已经是模块的端口字段io，所以要引用例化模块的某个具体端口时，路径里不用再出现“io”。</p>
</blockquote>
<p><strong>示例代码如下：</strong>的:::</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// mux4_2.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mux4_2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br><span class="hljs-comment">//io绑定接口实例</span><br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> in0 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in2 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in3 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">2.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><span class="hljs-comment">//从Module构造出Seq，再由序列构造为向量,并把向量每一个元素(这里是指模块实例)做例化</span><br>  <span class="hljs-keyword">val</span> m = <span class="hljs-type">VecInit</span>(<span class="hljs-type">Seq</span>.fill(<span class="hljs-number">3</span>)(<span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Mux2</span>).io))  <span class="hljs-comment">// 例化了三个Mux2，并且参数是端口字段io</span><br>  m(<span class="hljs-number">0</span>).sel := io.sel(<span class="hljs-number">0</span>)  <span class="hljs-comment">// 模块的端口通过下标索引，并且路径里没有“io”</span><br>  m(<span class="hljs-number">0</span>).in0 := io.in0<br>  m(<span class="hljs-number">0</span>).in1 := io.in1<br>  m(<span class="hljs-number">1</span>).sel := io.sel(<span class="hljs-number">0</span>)<br>  m(<span class="hljs-number">1</span>).in0 := io.in2<br>  m(<span class="hljs-number">1</span>).in1 := io.in3<br>  m(<span class="hljs-number">2</span>).sel := io.sel(<span class="hljs-number">1</span>)<br>  m(<span class="hljs-number">2</span>).in0 := m(<span class="hljs-number">0</span>).out<br>  m(<span class="hljs-number">2</span>).in1 := m(<span class="hljs-number">1</span>).out<br>  io.out := m(<span class="hljs-number">2</span>).out<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="3-4-线网"><a href="#3-4-线网" class="headerlink" title="3.4 线网"></a>3.4 线网</h2><p><strong>定义线网的方法：</strong>Chisel把线网作为电路的节点，通过工厂方法来定义</p>
<ul>
<li><code>Wire[T &lt;: Data](t: T)</code></li>
</ul>
<p><strong>线网的赋值、连接：</strong></p>
<ul>
<li>可以对线网进行赋值，也可以连接到其他电路节点，这是组成组合逻辑的基本硬件类型。例如：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> myNode = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>myNode := <span class="hljs-number">0.</span><span class="hljs-type">U</span> <br></code></pre></div></td></tr></table></figure>
<ul>
<li>对线网的多次驱动是可覆盖的： </li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> myNode = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>myNode := <span class="hljs-number">10.</span><span class="hljs-type">U</span><br>myNode := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><span class="hljs-comment">//最终myNode表现为0,10被覆盖</span><br></code></pre></div></td></tr></table></figure>
<h2 id="3-5-寄存器"><a href="#3-5-寄存器" class="headerlink" title="3.5 寄存器"></a>3.5 寄存器</h2><p><strong>寄存器特性：</strong></p>
<ul>
<li>寄存器是时序逻辑的基本硬件类型，它们都是由当前时钟域的时钟上升沿触发的。</li>
<li>如果模块里没有多时钟域的语句块，那么寄存器都是由隐式的全局时钟来控制。对于有复位信号的寄存器，如果不在多时钟域语句块里，则由隐式的全局复位来控制，并且高有效。</li>
<li>目前Chisel所有的复位都是同步复位，异步复位功能还在开发中。如果需要异步复位寄存器，则需要通过黑盒引入。</li>
</ul>
<p><strong>五种内建的寄存器：</strong>init复位、next输入、t位宽、enable是能</p>
<ul>
<li><strong>跟随寄存器</strong><code>RegNext[T &lt;: Data](next: T)</code>和<code>RegNext[T &lt;: Data](next: T, init: T)</code><ul>
<li>在每个时钟上升沿，它都会采样一次传入的参数，并且没有复位信号。它的另一个版本的apply工厂方法是<code>RegNext[T &lt;: Data](next: T, init: T)</code>，也就是由复位信号控制，当复位信号有效时，复位到指定值，否则就跟随。</li>
</ul>
</li>
<li><strong>复位到指定值的寄存器</strong><code>RegInit[T &lt;: Data](init: T)</code><ul>
<li>参数需要声明位宽，否则就是默认位宽。可以用内建的when语句进行条件赋值。</li>
</ul>
</li>
<li><strong>普通的寄存器</strong><code>Reg[T &lt;: Data](t: T)</code><ul>
<li>它可以在when语句里用全局reset信号进行同步复位(reset信号是Reset类型，要用toBool进行类型转换)，也可以进行条件赋值或无条件跟随。参数同样要指定位宽。</li>
</ul>
</li>
<li>util包里的带一个<strong>使能端的寄存</strong>器<code>RegEnable[T &lt;: Data](next: T, init: T, enable: Bool)</code><ul>
<li>如果不需要复位信号，则第二个参数可以省略给出。</li>
</ul>
</li>
<li>util包里的<strong>移位寄存器</strong><code>ShiftRegister[T &lt;: Data](in: T, n: Int, resetData: T, en: Bool)</code><ul>
<li>其中第一个参数in是带移位的数据，第二个参数n是需要延迟的周期数，第三个参数resetData是指定的复位值，可以省略，第四个参数en是使能移位的信号，默认为true.B。</li>
</ul>
</li>
</ul>
<p><strong>假如有如下代码：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// reg.scala</span><br><span class="hljs-keyword">package</span> test<br> <br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">REG</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> a = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> c = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br>  <span class="hljs-keyword">val</span> reg0 = <span class="hljs-type">RegNext</span>(io.a)<br>  <span class="hljs-keyword">val</span> reg1 = <span class="hljs-type">RegNext</span>(io.a, <span class="hljs-number">0.</span><span class="hljs-type">U</span>)<br>  <span class="hljs-keyword">val</span> reg2 = <span class="hljs-type">RegInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> reg3 = <span class="hljs-type">Reg</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> reg4 = <span class="hljs-type">Reg</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> reg5 = <span class="hljs-type">RegEnable</span>(io.a + <span class="hljs-number">1.</span><span class="hljs-type">U</span>, <span class="hljs-number">0.</span><span class="hljs-type">U</span>, io.en)<br>  <span class="hljs-keyword">val</span> reg6 = <span class="hljs-type">RegEnable</span>(io.a - <span class="hljs-number">1.</span><span class="hljs-type">U</span>, io.en)<br>  <span class="hljs-keyword">val</span> reg7 = <span class="hljs-type">ShiftRegister</span>(io.a, <span class="hljs-number">3</span>, <span class="hljs-number">0.</span><span class="hljs-type">U</span>, io.en)<br>  <span class="hljs-keyword">val</span> reg8 = <span class="hljs-type">ShiftRegister</span>(io.a, <span class="hljs-number">3</span>, io.en)<br>  <br>  reg2 := io.a.andR<br>  reg3 := io.a.orR<br>  when(reset.toBool) &#123;<br>    reg4 := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>  &#125; .otherwise &#123;<br>    reg4 := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>  &#125;<br>    <span class="hljs-comment">//regx(n) n表示寄存器位数</span><br>  io.c := reg0(<span class="hljs-number">0</span>) &amp; reg1(<span class="hljs-number">0</span>) &amp; reg2(<span class="hljs-number">0</span>) &amp; reg3(<span class="hljs-number">0</span>) &amp; reg4(<span class="hljs-number">0</span>) &amp; reg5(<span class="hljs-number">0</span>) &amp; reg6(<span class="hljs-number">0</span>) &amp; reg7(<span class="hljs-number">0</span>) &amp; reg8(<span class="hljs-number">0</span>)<br>&#125; <br></code></pre></div></td></tr></table></figure>
<p><strong>对应生成的主要Verilog代码为：</strong></p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// REG.v</span><br><span class="hljs-keyword">module</span> REG(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>  [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_a,<br>  <span class="hljs-keyword">input</span>        io_en,<br>  <span class="hljs-keyword">output</span>       io_c<br>);<br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg2; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg3; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg4; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg5; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">8</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_2; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">8</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_3; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_4; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg6; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_5; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_6; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg7; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_7; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_8; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg8; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_9; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_10; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_11; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>GEN_8; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_13; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_14; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_15; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_16; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_17; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_18; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_19; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_20; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_21; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_22; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_23; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_24; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_25; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_26; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_27; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_28; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_1 = io_a + <span class="hljs-number">8&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_2 = io_a - <span class="hljs-number">8&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_3 = <span class="hljs-built_in">$unsigned</span>(<span class="hljs-number">_</span>T_2); <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_4 = <span class="hljs-number">_</span>T_3[<span class="hljs-number">7</span>:<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_9 = ~ io_a; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_10 = <span class="hljs-number">_</span>T_9 == <span class="hljs-number">8&#x27;h0</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_11 = io_a != <span class="hljs-number">8&#x27;h0</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>GEN_8 = reset ? <span class="hljs-number">1&#x27;h0</span> : <span class="hljs-number">1&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_13 = reg0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_14 = reg1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_15 = <span class="hljs-number">_</span>T_13 &amp; <span class="hljs-number">_</span>T_14; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_16 = reg2[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_17 = <span class="hljs-number">_</span>T_15 &amp; <span class="hljs-number">_</span>T_16; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_18 = reg3[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_19 = <span class="hljs-number">_</span>T_17 &amp; <span class="hljs-number">_</span>T_18; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_20 = reg4[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_21 = <span class="hljs-number">_</span>T_19 &amp; <span class="hljs-number">_</span>T_20; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_22 = reg5[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_23 = <span class="hljs-number">_</span>T_21 &amp; <span class="hljs-number">_</span>T_22; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_24 = reg6[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_25 = <span class="hljs-number">_</span>T_23 &amp; <span class="hljs-number">_</span>T_24; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_26 = reg7[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_27 = <span class="hljs-number">_</span>T_25 &amp; <span class="hljs-number">_</span>T_26; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_28 = reg8[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> io_c = <span class="hljs-number">_</span>T_27 &amp; <span class="hljs-number">_</span>T_28; <br> <br>  <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clock) <span class="hljs-keyword">begin</span><br>    reg0 &lt;= io_a;<br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg1 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg2 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg2 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_10&#125;;<br>    <span class="hljs-keyword">end</span><br>    reg3 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_11&#125;;<br>    reg4 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>GEN_8&#125;;<br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg5 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg5 &lt;= <span class="hljs-number">_</span>T_1;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg6 &lt;= <span class="hljs-number">_</span>T_4;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_5 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_5 &lt;= io_a;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_6 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_6 &lt;= <span class="hljs-number">_</span>T_5;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg7 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg7 &lt;= <span class="hljs-number">_</span>T_6;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_7 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_8 &lt;= <span class="hljs-number">_</span>T_7;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg8 &lt;= <span class="hljs-number">_</span>T_8;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<h2 id="3-6-寄存器组"><a href="#3-6-寄存器组" class="headerlink" title="3.6 寄存器组"></a>3.6 寄存器组</h2><p>五种内建寄存器的工厂方法，它们的参数可以是任何Data的子类型。如果<strong>把子类型Vec[T]作为参数传递进去（vec[T]可通过VecInit创建），就会生成多个位宽相同、行为相同、名字前缀相同的寄存器</strong>。同样，<strong>寄存器组在Chisel代码里可以通过下标索引</strong></p>
<p><strong>假如有如下代码：</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// reg2.scala</span><br><span class="hljs-keyword">package</span> test<br> <br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">REG2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> a = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> c = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br>  <span class="hljs-comment">//reg0 vecinit创建vec[T] 1个参数为向量，向量内元素1个</span><br>  <span class="hljs-keyword">val</span> reg0 = <span class="hljs-type">RegNext</span>(<span class="hljs-type">VecInit</span>(io.a, io.a))<br>  <span class="hljs-comment">//reg1 vecinit创建vec[T] 2个参数为向量，向量内元素1个</span><br>  <span class="hljs-keyword">val</span> reg1 = <span class="hljs-type">RegNext</span>(<span class="hljs-type">VecInit</span>(io.a, io.a), <span class="hljs-type">VecInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>, <span class="hljs-number">0.</span><span class="hljs-type">U</span>))<br>  <span class="hljs-comment">//reg2 vecinit创建vec[T] 1个参数为向量，向量内元素2个</span><br>  <span class="hljs-keyword">val</span> reg2 = <span class="hljs-type">RegInit</span>(<span class="hljs-type">VecInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>), <span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-comment">//reg3     vec创建vec[T] 1个参数为向量，向量内元素2个</span><br>  <span class="hljs-keyword">val</span> reg3 = <span class="hljs-type">Reg</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">2</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-comment">//reg4     vec创建vec[T] 1个参数为向量，向量内元素2个</span><br>  <span class="hljs-keyword">val</span> reg4 = <span class="hljs-type">Reg</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">2</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-comment">//reg5 vecinit创建vec[T] 2个参数为向量，向量内元素1个</span><br>  <span class="hljs-keyword">val</span> reg5 = <span class="hljs-type">RegEnable</span>(<span class="hljs-type">VecInit</span>(io.a + <span class="hljs-number">1.</span><span class="hljs-type">U</span>, io.a + <span class="hljs-number">1.</span><span class="hljs-type">U</span>), <span class="hljs-type">VecInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>), <span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)), io.en)<br>  <span class="hljs-comment">//reg6 vecinit创建vec[T] 1个参数为向量，向量内元素1个</span><br>  <span class="hljs-keyword">val</span> reg6 = <span class="hljs-type">RegEnable</span>(<span class="hljs-type">VecInit</span>(io.a - <span class="hljs-number">1.</span><span class="hljs-type">U</span>, io.a - <span class="hljs-number">1.</span><span class="hljs-type">U</span>), io.en)<br>  <span class="hljs-comment">//reg7 vecinit创建vec[T] 2个参数为向量，向量内元素1个</span><br>  <span class="hljs-keyword">val</span> reg7 = <span class="hljs-type">ShiftRegister</span>(<span class="hljs-type">VecInit</span>(io.a, io.a), <span class="hljs-number">3</span>, <span class="hljs-type">VecInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>), <span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)), io.en)<br>  <span class="hljs-comment">//reg8 vecinit创建vec[T] 1个参数为向量，向量内元素2个</span><br>  <span class="hljs-keyword">val</span> reg8 = <span class="hljs-type">ShiftRegister</span>(<span class="hljs-type">VecInit</span>(io.a, io.a), <span class="hljs-number">3</span>, io.en)<br>  <br>  reg2(<span class="hljs-number">0</span>) := io.a.andR<br>  reg2(<span class="hljs-number">1</span>) := io.a.andR<br>  reg3(<span class="hljs-number">0</span>) := io.a.orR<br>  reg3(<span class="hljs-number">1</span>) := io.a.orR<br>  when(reset.toBool) &#123;<br>    reg4(<span class="hljs-number">0</span>) := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>    reg4(<span class="hljs-number">1</span>) := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br>  &#125; .otherwise &#123;<br>    reg4(<span class="hljs-number">0</span>) := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>    reg4(<span class="hljs-number">1</span>) := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>  &#125;<br>  io.c := reg0(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg1(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg2(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg3(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg4(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg5(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg6(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg7(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp; reg8(<span class="hljs-number">0</span>)(<span class="hljs-number">0</span>) &amp;<br>          reg0(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg1(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg2(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg3(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg4(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg5(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg6(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg7(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>) &amp; reg8(<span class="hljs-number">1</span>)(<span class="hljs-number">0</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>对应的主要Verilog代码为：</strong></p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// REG2.v</span><br><span class="hljs-keyword">module</span> REG2(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>  [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_a,<br>  <span class="hljs-keyword">input</span>        io_en,<br>  <span class="hljs-keyword">output</span>       io_c<br>);<br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg0_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg0_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg1_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg1_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg2_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg2_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg3_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg3_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg4_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg4_1; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_5; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg5_0;   <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg5_1; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">8</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_10; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">8</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_11; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_12; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg6_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg6_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_19_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_19_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_20_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_20_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg7_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg7_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_22_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_22_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_23_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_23_1; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg8_0; <br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] reg8_1; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_24; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_25; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_28; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>GEN_16; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_31; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_32; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_33; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_34; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_35; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_36; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_37; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_38; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_39; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_40; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_41; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_42; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_43; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_44; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_45; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_46; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_47; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_48; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_49; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_50; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_51; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_52; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_53; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_54; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_55; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_56; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_57; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_58; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_59; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_60; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_61; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_62; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_63; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_64; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_5 = io_a + <span class="hljs-number">8&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_10 = io_a - <span class="hljs-number">8&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_11 = <span class="hljs-built_in">$unsigned</span>(<span class="hljs-number">_</span>T_10); <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_12 = <span class="hljs-number">_</span>T_11[<span class="hljs-number">7</span>:<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_24 = ~ io_a; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_25 = <span class="hljs-number">_</span>T_24 == <span class="hljs-number">8&#x27;h0</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_28 = io_a != <span class="hljs-number">8&#x27;h0</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>GEN_16 = reset ? <span class="hljs-number">1&#x27;h0</span> : <span class="hljs-number">1&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_31 = reg0_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_32 = reg1_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_33 = <span class="hljs-number">_</span>T_31 &amp; <span class="hljs-number">_</span>T_32; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_34 = reg2_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_35 = <span class="hljs-number">_</span>T_33 &amp; <span class="hljs-number">_</span>T_34; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_36 = reg3_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_37 = <span class="hljs-number">_</span>T_35 &amp; <span class="hljs-number">_</span>T_36; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_38 = reg4_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_39 = <span class="hljs-number">_</span>T_37 &amp; <span class="hljs-number">_</span>T_38; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_40 = reg5_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_41 = <span class="hljs-number">_</span>T_39 &amp; <span class="hljs-number">_</span>T_40; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_42 = reg6_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_43 = <span class="hljs-number">_</span>T_41 &amp; <span class="hljs-number">_</span>T_42; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_44 = reg7_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_45 = <span class="hljs-number">_</span>T_43 &amp; <span class="hljs-number">_</span>T_44; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_46 = reg8_0[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_47 = <span class="hljs-number">_</span>T_45 &amp; <span class="hljs-number">_</span>T_46; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_48 = reg0_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_49 = <span class="hljs-number">_</span>T_47 &amp; <span class="hljs-number">_</span>T_48; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_50 = reg1_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_51 = <span class="hljs-number">_</span>T_49 &amp; <span class="hljs-number">_</span>T_50; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_52 = reg2_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_53 = <span class="hljs-number">_</span>T_51 &amp; <span class="hljs-number">_</span>T_52; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_54 = reg3_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_55 = <span class="hljs-number">_</span>T_53 &amp; <span class="hljs-number">_</span>T_54; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_56 = reg4_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_57 = <span class="hljs-number">_</span>T_55 &amp; <span class="hljs-number">_</span>T_56; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_58 = reg5_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_59 = <span class="hljs-number">_</span>T_57 &amp; <span class="hljs-number">_</span>T_58; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_60 = reg6_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_61 = <span class="hljs-number">_</span>T_59 &amp; <span class="hljs-number">_</span>T_60; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_62 = reg7_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_63 = <span class="hljs-number">_</span>T_61 &amp; <span class="hljs-number">_</span>T_62; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_64 = reg8_1[<span class="hljs-number">0</span>]; <br>  <span class="hljs-keyword">assign</span> io_c = <span class="hljs-number">_</span>T_63 &amp; <span class="hljs-number">_</span>T_64; <br>  <br>  <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clock) <span class="hljs-keyword">begin</span><br>    reg0_0 &lt;= io_a;<br>    reg0_1 &lt;= io_a;<br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg1_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg1_0 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg1_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg1_1 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg2_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg2_0 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_25&#125;;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg2_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      reg2_1 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_25&#125;;<br>    <span class="hljs-keyword">end</span><br>    reg3_0 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_28&#125;;<br>    reg3_1 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>T_28&#125;;<br>    reg4_0 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>GEN_16&#125;;<br>    reg4_1 &lt;= &#123;&#123;<span class="hljs-number">7&#x27;d0</span>&#125;, <span class="hljs-number">_</span>GEN_16&#125;;<br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg5_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg5_0 &lt;= <span class="hljs-number">_</span>T_5;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg5_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg5_1 &lt;= <span class="hljs-number">_</span>T_5;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg6_0 &lt;= <span class="hljs-number">_</span>T_12;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg6_1 &lt;= <span class="hljs-number">_</span>T_12;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_19_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_19_0 &lt;= io_a;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_19_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_19_1 &lt;= io_a;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_20_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_20_0 &lt;= <span class="hljs-number">_</span>T_19_0;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_20_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-number">_</span>T_20_1 &lt;= <span class="hljs-number">_</span>T_19_1;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg7_0 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg7_0 &lt;= <span class="hljs-number">_</span>T_20_0;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      reg7_1 &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        reg7_1 &lt;= <span class="hljs-number">_</span>T_20_1;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_22_0 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_22_1 &lt;= io_a;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_23_0 &lt;= <span class="hljs-number">_</span>T_22_0;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      <span class="hljs-number">_</span>T_23_1 &lt;= <span class="hljs-number">_</span>T_22_1;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg8_0 &lt;= <span class="hljs-number">_</span>T_23_0;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>      reg8_1 &lt;= <span class="hljs-number">_</span>T_23_1;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<h2 id="3-7-用when给电路赋值-if-else-if-else"><a href="#3-7-用when给电路赋值-if-else-if-else" class="headerlink" title="3.7 用when给电路赋值(if else if else)"></a>3.7 用when给电路赋值(if else if else)</h2><p>在Verilog里，可以使用“if…else if…else”这样的条件选择语句来方便地构建电路的逻辑。由于Scala已经占用了“if…else if…else”语法，所以相应的<strong>Chisel控制结构改成了when语句</strong>，其语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs chisel">when (condition 1) &#123; definition 1 &#125;<br>.elsewhen (condition 2) &#123; definition 2 &#125;<br>...<br>.elsewhen (condition N) &#123; definition N &#125;<br>.otherwise &#123; default behavior &#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>特别注意：</strong></p>
<ul>
<li><p><code>.elsewhen</code>和<code>.otherwise</code>的开头有两个句点</p>
</li>
<li><p>所有的判断条件都是返回Bool类型的传名参数，不要和Scala的Boolean类型混淆</p>
<ul>
<li><strong>不存在Boolean和Bool之间的相互转换</strong></li>
<li>对于<strong>UInt、SInt和Reset类型，可以用方法toBool转换成Bool类型来作为判断条件</strong></li>
</ul>
</li>
<li><p><strong>when语句不仅可以给线网赋值，还可以给寄存器赋值</strong>，但是要注意构建组合逻辑时不能缺失“.otherwise”分支</p>
</li>
</ul>
<p><strong>使用情况：</strong></p>
<ul>
<li>通常，<strong>when用于</strong>给带使能信号的<strong>寄存器</strong>更新数据，<strong>组合逻辑不常用</strong><ul>
<li>对于有复位信号的寄存器，<strong>推荐使用<code>RegInit</code>来声明</strong>，这样生成的Verilog会自动根据当前的时钟域来同步复位，<strong>尽量不要在when语句里用<code>reset.toBool</code>作为复位条件</strong></li>
</ul>
</li>
</ul>
<p><strong>unless结构：</strong></p>
<ul>
<li>除了when结构，util包里还有一个与之对偶的结构<code>unless</code>，<strong>如果unless的判定条件为false.B则一直执行，否则不执行：</strong></li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> chisel3.util._<br><br>unless (condition) &#123; definition &#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="3-8-总结：数据类型与硬件类型的区别"><a href="#3-8-总结：数据类型与硬件类型的区别" class="headerlink" title="3.8 总结：数据类型与硬件类型的区别"></a>3.8 总结：数据类型与硬件类型的区别</h2><p>前一章介绍了Chisel的数据类型，其中常用的就五种：UInt、SInt、Bool、Bundle和Vec[T]。本章介绍了硬件类型，最基本的是IO、Wire和Reg三种，还有指明端口方向的Input、Output和Flipped。Module是沿袭了Verilog用模块构建电路的规则，不仅让熟悉Verilog/VHDL的工程师方便理解，也便于从Chisel转化成Verilog代码。</p>
<p>数据类型必须配合硬件类型才能使用，它不能独立存在，因为编译器只会把硬件类型生成对应的Verilog代码。从语法规则上来讲，这两种类型也有很大的区别，编译器会对数据类型和硬件类型加以区分。尽管从Scala的角度来看，硬件类型对应的工厂方法仅仅是“封装”了一遍作为入参的数据类型，其返回结果没变，比如Wire的工厂方法定义为：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>[<span class="hljs-type">T</span> &lt;: <span class="hljs-type">Data</span>](t: <span class="hljs-type">T</span>)(<span class="hljs-keyword">implicit</span> sourceInfo: <span class="hljs-type">SourceInfo</span>, compileOptions: <span class="hljs-type">CompileOptions</span>): <span class="hljs-type">T</span><br></code></pre></div></td></tr></table></figure>
<p>可以看到，入参t的类型与返回结果的类型是一样的，但是还有配置编译器的隐式参数，很可能区别就源自这里。</p>
<p>但是从Chisel编译器的角度来看，这两者就是不一样。换句话说，硬件类型就好像在数据类型上“包裹了一层外衣(英文原文用单词binding来形容)”。比如，线网“Wire(UInt(8.W))”就像给数据类型“UInt(8.W)”包上了一个“Wire( )”。所以，在编写Chisel时，要注意哪些地方是数据类型，哪些地方又是硬件类型。这时，静态语言的优势便体现出来了，因为编译器会帮助程序员检查类型是否匹配。如果在需要数据类型的地方出现了硬件类型、在需要硬件类型的地方出现了数据类型，那么就会引发错误。程序员只需要按照错误信息去修改相应的代码，而不需要人工逐个检查。</p>
<p>例如，在前面介绍寄存器组的时候，示例代码里的一句是这样的：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> reg0 = <span class="hljs-type">RegNext</span>(<span class="hljs-type">VecInit</span>(io.a, io.a)) <br></code></pre></div></td></tr></table></figure>
<p>读者可能会好奇为什么不写成如下形式：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> reg0 = <span class="hljs-type">RegNext</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">2</span>, io.a)) <br></code></pre></div></td></tr></table></figure>
<p>如果改成这样，那么编译器就会发出如下错误：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala">[error] chisel3.core.<span class="hljs-type">Binding</span>$<span class="hljs-type">ExpectedChiselTypeException</span>: vec <span class="hljs-class"><span class="hljs-keyword">type</span> &#x27;<span class="hljs-title">chisel3</span>.<span class="hljs-title">core</span>.<span class="hljs-title">UInt@6147b2fd</span>&#x27; <span class="hljs-title">must</span> <span class="hljs-title">be</span> <span class="hljs-title">a</span> <span class="hljs-title">Chisel</span> <span class="hljs-title">type</span>, <span class="hljs-title">not</span> <span class="hljs-title">hardware</span> </span><br></code></pre></div></td></tr></table></figure>
<p>这是因为方法Vec期望第二个参数是数据类型，这样它才能推断出返回的Vec[T]是数据类型。但实际的“io.a”是经过Input封装过的硬件类型，导致Vec[T]变成了硬件类型，所以发生了类型匹配错误。错误信息里也明确指示了，“Chisel type”指的就是数据类型，“hardware”指的就是硬件类型，而vec的类型应该是“Chisel type”，不应该变成硬件。</p>
<p>Chisel提供了一个用户API——chiselTypeOf<a href="target: T">T &lt;: Data</a>: T，其作用就是把硬件类型的“封皮”去掉，变成纯粹的数据类型。因此，读者可能会期望如下代码成功：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> reg0 = <span class="hljs-type">RegNext</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">2</span>, chiselTypeOf(io.a)))  <br></code></pre></div></td></tr></table></figure>
<p>但是编译器仍然发出了错误信息：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala">[error] chisel3.core.<span class="hljs-type">Binding</span>$<span class="hljs-type">ExpectedHardwareException</span>: reg next <span class="hljs-symbol">&#x27;Vec</span>(chisel3.core.<span class="hljs-type">UInt</span>@<span class="hljs-number">65</span>b0972a, chisel3.core.<span class="hljs-type">UInt</span>@<span class="hljs-number">25155</span>aa4)&#x27; must be hardware, not a bare <span class="hljs-type">Chisel</span> <span class="hljs-keyword">type</span>. <span class="hljs-type">Perhaps</span> you forgot to wrap it in <span class="hljs-type">Wire</span>(_) or <span class="hljs-type">IO</span>(_)? <br></code></pre></div></td></tr></table></figure>
<p>只不过，这次是RegNext出错了。chiselTypeOf确实把硬件类型变成了数据类型，所以Vec[T]的检查通过了。但RegNext是实打实的硬件——寄存器，它也需要根据入参来推断返回结果的类型，所以传入一个数据类型Vec[T]就引发了错误。错误信息还额外提示程序员，是否忘记了用Wire(<em>)或IO(</em>)来包裹裸露的数据类型。甚至是带有字面量的数据类型，比如“0.U(8.W)”这样的对象，也被当作是硬件类型。</p>
<p>综合考虑这两种错误，只有写成“val reg0 = RegNext(VecInit(io.a, io.a))”合适，因为VecInit专门接收硬件类型的参数来构造硬件向量，给VecInit传入数据类型反而会报错，尽管它的返回类型也是Vec[T]。另外，Reg(_)的参数是数据类型，不是硬件类型，所以示例代码中它的参数是Vec，而别的参数都是VecInit。</p>
<p>有了基本的数据类型和硬件类型后，就已经可以编写绝大多数组合逻辑与时序逻辑电路。下一章将介绍Chisel库里定义的常用原语，有了这些原语就能更快速地构建电路，而不需要只用这些基本类型来搭积木。</p>
<h1 id="4-常用的硬件原语"><a href="#4-常用的硬件原语" class="headerlink" title="4 常用的硬件原语"></a>4 常用的硬件原语</h1><p>前两章介绍了基本的数据类型和硬件类型，已经足够编写基本的小规模电路。至于要如何生成Verilog，会在后续章节讲解。如果要编写大型电路，当然也可以一砖一瓦地搭建，但是费时费力，完全体现不出软件语言的优势。Chisel在语言库里定义了很多常用的硬件原语，读者可以直接导入相应的包来使用。让编译器多干活，让程序员少费力，本章介绍的常用原语有：</p>
<ul>
<li>多路选择器</li>
<li>ROM</li>
<li>RAM</li>
<li>带写掩膜的RAM</li>
<li>从文件读取到RAM</li>
<li>计数器</li>
<li>16位线性反馈移位寄存器</li>
<li>状态机（不是原语）</li>
</ul>
<p>本章介绍了Chisel内建的常用原语，还有更多原语可以使用，比如Bundle衍生的几种端口类，读者可以通过查询API或源码来进一步了解。</p>
<h2 id="4-1-多路选择器"><a href="#4-1-多路选择器" class="headerlink" title="4.1 多路选择器"></a>4.1 多路选择器</h2><p>因为多路选择器是一个很常用的电路模块，所以<strong>Chisel内建了几种多路选择器</strong>：</p>
<ul>
<li><p><strong>二输入多路选择器(Mux)，形式为</strong><code>Mux(sel, in1, in2)</code>：sel是Bool类型，in1和in2的类型相同，都是Data的任意子类型。当sel为true.B时，返回in1，否则返回in2</p>
<ul>
<li>因为Mux仅仅是把一个输入返回，所以Mux可以内嵌Mux，构成<strong>n输入多路选择器(嵌套Mux)</strong>，类似于嵌套的三元操作符。其<strong>形式为</strong><code>Mux(c1, a, Mux(c2, b, Mux(..., default)))</code></li>
</ul>
</li>
<li><p><strong>n输入多路选择器的简便写法(MuxCase)</strong>，MuxCase在<u>chisel3.util</u>包里，形式为<code>MuxCase(default, Array(c1 -&gt; a, c2 -&gt; b, ...))</code>，它的展开与嵌套的Mux是一样的：第一个参数是默认情况下返回的结果，第二个参数是一个数组，数组的元素是对偶<code>(成立条件，被选择的输入)</code></p>
</li>
<li><strong>查找表(MuxLookup)</strong>，第三种是MuxCase的变体也在<u>chisel3.uti</u>l包里，它相当于把MuxCase的成立条件依次换成从0开始的索引值像一个查找表，其<strong>形式为</strong><code>MuxLookup(idx, default, Array(0.U -&gt; a, 1.U -&gt; b, ...))</code>。它的展开相当于<code>MuxCase(default, Array((idx === 0.U) -&gt; a, (idx === 1.U) -&gt; b, ...))</code></li>
<li><strong>独热码多路选择器(Mux1H)</strong>：第四种是<u>chisel3.util</u>包里的，它的选择信号是一个独热码。如果零个或多个选择信号有效，则行为未定义。<strong>其形式如下</strong>：</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> hotValue = <span class="hljs-type">Mux1H</span>(<span class="hljs-type">Seq</span>(<br>    io.selector(<span class="hljs-number">0</span>) -&gt; <span class="hljs-number">2.</span><span class="hljs-type">U</span>,<br>    io.selector(<span class="hljs-number">1</span>) -&gt; <span class="hljs-number">4.</span><span class="hljs-type">U</span>,<br>    io.selector(<span class="hljs-number">2</span>) -&gt; <span class="hljs-number">8.</span><span class="hljs-type">U</span>,<br>    io.selector(<span class="hljs-number">4</span>) -&gt; <span class="hljs-number">11.</span><span class="hljs-type">U</span><br>))<br></code></pre></div></td></tr></table></figure>
<p><strong>内建的多路选择器会转换成Verilog的三元操作符<code>? :</code></strong>，这对于构建组合逻辑而言是完全足够的，而且更推荐这种做法，</p>
<p><strong>when语句常用于给寄存器赋值</strong>，而很少用来给线网赋值。读者可能习惯用always语句块来编写电路，但这存在一些问题：首先，always既可以综合出时序逻辑又能综合出组合逻辑，导致reg变量存在二义性，常常使得新手误解reg就是寄存器；其次，if…else if…else不能传播控制变量的未知态x(某些EDA工具可以)，使得仿真阶段无法发现一些错误，但是assign语句会在控制变量为x时也输出x。工业级的Verilog，都是用assign语句来构建电路。时序逻辑也是通过例化触发器模块来完成的，相应的端口都是由assign来驱动，而且触发器会使用SystemVerilog的断言来寻找always语句里的x和z。整个设计应该尽量避免使用always语句。 </p>
<h2 id="4-2-ROM"><a href="#4-2-ROM" class="headerlink" title="4.2 ROM"></a>4.2 ROM</h2><p>可以通过工厂方法：</p>
<p>​        <code>VecInit[T &lt;: Data](elt0: T, elts: T*)</code>    和    <code>VecInit[T &lt;: Data](elts: Seq[T])</code></p>
<p>来创建一个只读存储器，参数就是ROM里的常量数值，对应的Verilog代码就是给读取ROM的线网或寄存器赋予常量值。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// rom.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ROM</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">2.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))  <br>  &#125;)<br><br>  <span class="hljs-keyword">val</span> rom = <span class="hljs-type">VecInit</span>(<span class="hljs-number">1.</span><span class="hljs-type">U</span>, <span class="hljs-number">2.</span><span class="hljs-type">U</span>, <span class="hljs-number">3.</span><span class="hljs-type">U</span>, <span class="hljs-number">4.</span><span class="hljs-type">U</span>)<br><br>  io.out := rom(io.sel)<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>对应的Verilog为：</p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// ROM.v</span><br><span class="hljs-keyword">module</span> ROM(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>  [<span class="hljs-number">1</span>:<span class="hljs-number">0</span>] io_sel,<br>  <span class="hljs-keyword">output</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_out<br>);<br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>GEN_1; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>GEN_2; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>GEN_3; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>GEN_1 = <span class="hljs-number">2&#x27;h1</span> == io_sel ? <span class="hljs-number">3&#x27;h2</span> : <span class="hljs-number">3&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>GEN_2 = <span class="hljs-number">2&#x27;h2</span> == io_sel ? <span class="hljs-number">3&#x27;h3</span> : <span class="hljs-number">_</span>GEN_1; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>GEN_3 = <span class="hljs-number">2&#x27;h3</span> == io_sel ? <span class="hljs-number">3&#x27;h4</span> : <span class="hljs-number">_</span>GEN_2; <br>  <span class="hljs-keyword">assign</span> io_out = &#123;&#123;<span class="hljs-number">5&#x27;d0</span>&#125;, <span class="hljs-number">_</span>GEN_3&#125;;<br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<p>在这个例子里需要提的一点是，Vec[T]类的apply方法不仅可以接收Int类型的索引值，另一个重载版本还能接收UInt类型的索引值。所以对于承担地址、计数器等功能的部件，可以直接作为由Vec[T]构造的元素的索引参数，比如这个例子中根据sel端口的值来选择相应地址的ROM值。</p>
<h2 id="4-3-RAM"><a href="#4-3-RAM" class="headerlink" title="4.3 RAM"></a>4.3 RAM</h2><p>Chisel支持两种类型的RAM。第一种RAM是同步(时序)写，异步(组合逻辑)读，通过工厂方法“Mem<a href="size: Int, t: T">T &lt;: Data</a>”来构建。例如：</p>
<p>val asyncMem = Mem(16, UInt(32.W)) </p>
<p>由于现代的FPGA和ASIC技术已经不再支持异步读RAM，所以这种RAM会被综合成寄存器阵列。第二种RAM则是同步(时序)读、写，通过工厂方法“SyncReadMem<a href="size: Int, t: T">T &lt;: Data</a>”来构建，这种RAM会被综合成实际的SRAM。在Verilog代码上，这两种RAM都是由reg类型的变量来表示的，区别在于第二种RAM的读地址会被地址寄存器寄存一次。例如：</p>
<p>val syncMem = SyncReadMem(16, UInt(32.W))</p>
<p>写RAM的语法是：</p>
<p>when(wr_en) {undefined<br>     mem.write(address, dataIn)<br>     out := DontCare<br>}</p>
<p>其中DontCare告诉Chisel的未连接线网检测机制，写入RAM时读端口的行为无需关心。</p>
<p>读RAM的语法是：</p>
<p>out := mem.read(address, rd_en)</p>
<p>读、写使能信号都可以省略。</p>
<p>要综合出实际的SRAM，读者最好了解自己的综合器是如何推断的，按照综合器的推断规则来编写模块的端口定义、时钟域划分、读写使能的行为等等，否则就可能综合出寄存器阵列而不是SRAM。以Vivado 2018.3为例，下面的单端口SRAM代码经过综合后会映射到FPGA上实际的BRAM资源，而不是寄存器：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// ram.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SinglePortRAM</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> addr = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">10.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> dataIn = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> we = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> dataOut = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))  <br>  &#125;)<br>  <span class="hljs-keyword">val</span> syncRAM = <span class="hljs-type">SyncReadMem</span>(<span class="hljs-number">1024</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>  when(io.en) &#123;<br>    when(io.we) &#123;<br>      syncRAM.write(io.addr, io.dataIn)<br>      io.dataOut := <span class="hljs-type">DontCare</span><br>    &#125; .otherwise &#123;<br>      io.dataOut := syncRAM.read(io.addr)<br>    &#125;<br>  &#125; .otherwise &#123;<br>    io.dataOut := <span class="hljs-type">DontCare</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>下面是Vivado综合后的部分截图，可以看到确实变成了实际的BRAM：</p>
<p>Vivado综合出来的单端口BRAM<br>Vivado的BRAM最多支持真·双端口，按照对应的Verilog模板逆向编写Chisel，然后用编译器把Chisel转换成Verilog。但此时编译器生成的Verilog代码并不能被Vivado的综合器识别出来。原因在于SyncReadMem生成的Verilog代码是用一级寄存器保存输入的读地址，然后用读地址寄存器去异步读取RAM的数据，而Vivado的综合器识别不出这种模式的RAM。读者必须手动修改成用一级寄存器保存异步读取的数据而不是读地址，然后把读数据寄存器的内容用assign语句赋值给读数据端口，这样才能被识别成真·双端口BRAM。尚不清楚其它综合器是否有这个问题。经过咨询SiFive的工作人员，对方答复因为当前转换的代码把延迟放在地址一侧，所以流水线的节拍设计也是根据这个来的。考虑到贸然修改SyncReadMem的行为，可能会潜在地影响其它用户对流水线的设计，故而没有修改计划。如果确实需要自定义的、对综合器友好的Verilog代码，可以使用黑盒功能替代，或者给Firrtl编译器传入参数，改用自定义脚本来编译Chisel。</p>
<h2 id="4-4-带写掩模的RAM"><a href="#4-4-带写掩模的RAM" class="headerlink" title="4.4 带写掩模的RAM"></a>4.4 带写掩模的RAM</h2><p>RAM通常都具备按字节写入的功能，比如数据写入端口的位宽是32bit，那么就应该有4bit的写掩模信号，只有当写掩模比特有效时，对应的字节才会写入。Chisel也具备构建带写掩模的RAM的功能。</p>
<p>当构建RAM的数据类型为Vec[T]时，就会推断出该RAM具有写掩模。此时，需要定义一个Seq[Bool]类型的写掩模信号，序列的元素个数为数据写入端口的位宽除以字节宽度。而write方法有一个重载版本，就是第三个参数是接收写掩模信号的。当下标为0的写掩模比特是true.B时，最低的那个字节会被写入，依次类推。下面是一个带写掩模的单端口RAM：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// maskram.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaskRAM</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> addr = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">10.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> dataIn = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> we = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> dataOut = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))  <br>  &#125;)<br>  <span class="hljs-keyword">val</span> dataIn_temp = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-keyword">val</span> dataOut_temp = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-keyword">val</span> mask = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>, <span class="hljs-type">Bool</span>()))<br>  <span class="hljs-keyword">val</span> syncRAM = <span class="hljs-type">SyncReadMem</span>(<span class="hljs-number">1024</span>, <span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>  when(io.en) &#123;<br>    syncRAM.write(io.addr, dataIn_temp, mask)<br>    dataOut_temp := syncRAM.read(io.addr)<br>  &#125; .otherwise &#123;<br>    dataOut_temp := <span class="hljs-type">DontCare</span><br>  &#125; <br>  <span class="hljs-keyword">for</span>(i &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">4</span>) &#123;<br>    dataIn_temp(i) := io.dataIn(<span class="hljs-number">8</span>*i+<span class="hljs-number">7</span>, <span class="hljs-number">8</span>*i)<br>    mask(i) := io.we(i).toBool<br>    io.dataOut := <span class="hljs-type">Cat</span>(dataOut_temp(<span class="hljs-number">3</span>), dataOut_temp(<span class="hljs-number">2</span>), dataOut_temp(<span class="hljs-number">1</span>), dataOut_temp(<span class="hljs-number">0</span>))<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>读、写端口和写掩模可以不用定义成一个UInt，也可以是Vec[UInt]，这样定义只是为了让模块对外只有一个读端口、一个写端口和一个写掩模端口。注意，编译器会把Vec[T]的元素逐个展开，而不是合并成压缩数组的形式。也正是如此，上述代码对应的Verilog中，把RAM主体定义成了“reg [7:0] syncRAM_0 [0:1023]”、“reg [7:0] syncRAM_1 [0:1023]”、“reg [7:0] syncRAM_2 [0:1023]”和“reg [7:0] syncRAM_3 [0:1023]”，而不是一个“reg [31:0] syncRAM [0:1023]”。这样，Vivado综合出来的电路是四小块BRAM，而不是一大块BRAM。</p>
<h2 id="4-5-从文件读取数据到RAM"><a href="#4-5-从文件读取数据到RAM" class="headerlink" title="4.5 从文件读取数据到RAM"></a>4.5 从文件读取数据到RAM</h2><p>在experimental包里有一个单例对象loadMemoryFromFile，它的apply方法可以在Chisel层面上从txt文件读取数据到RAM里。其定义如下所示：</p>
<p>def apply<a href="memory: MemBase[T], fileName: String, hexOrBinary: FileType = MemoryLoadFileType.Hex">T &lt;: Data</a>: Unit</p>
<p>第一个参数是MemBase[T]类型的，也就是Mem[T]和SyncReadMem[T]的超类，该参数接收一个自定义的RAM对象。第二个参数是文件的名字及路径，用字符串表示。第三个参数表示读取的方式为十六进制或二进制，默认是MemoryLoadFileType.Hex，也可以改成MemoryLoadFileType.Binary。注意，没有十进制和八进制。</p>
<p>该方法其实就是调用Verilog的系统函数“$readmemh”和“$readmemb”，所以要注意文件路径的书写和数据的格式都要按照Verilog的要求书写。最好把数据文件放在resources文件夹里。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// loadmem.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util.experimental.loadMemoryFromFile<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadMem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> address = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">3.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> value   = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>  &#125;)<br>  <span class="hljs-keyword">val</span> memory = <span class="hljs-type">Mem</span>(<span class="hljs-number">8</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>  io.value := memory.read(io.address)<br>  loadMemoryFromFile(memory, <span class="hljs-string">&quot;~/chisel-workspace/chisel-template/mem.txt&quot;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>那么就会得到两个Verilog文件：</p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// LoadMem.v</span><br><span class="hljs-keyword">module</span> LoadMem(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>  [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] io_address,<br>  <span class="hljs-keyword">output</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_value<br>);<br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] memory [<span class="hljs-number">0</span>:<span class="hljs-number">7</span>]; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] memory__T_data; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] memory__T_addr; <br>  <span class="hljs-keyword">assign</span> memory__T_addr = io_address;<br>  <span class="hljs-keyword">assign</span> memory__T_data = memory[memory__T_addr]; <br>  <span class="hljs-keyword">assign</span> io_value = memory__T_data;<br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-comment">// LoadMem.LoadMem.memory.v</span><br><span class="hljs-keyword">module</span> BindsTo_0_LoadMem(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>  [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] io_address,<br>  <span class="hljs-keyword">output</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_value<br>);<br><br><span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>  <span class="hljs-built_in">$readmemh</span>(<span class="hljs-string">&quot;~/chisel-workspace/chisel-template/mem.txt&quot;</span>, LoadMem<span class="hljs-variable">.memory</span>);<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<p>在用Verilator仿真时，它会识别这个Chisel代码，从文件读取数据。 </p>
<h2 id="4-6-计数器"><a href="#4-6-计数器" class="headerlink" title="4.6 计数器"></a>4.6 计数器</h2><p>计数器也是一个常用的硬件电路。Chisel在util包里定义了一个自增计数器原语Counter，它的工厂方法接收两个参数：第一个参数是Bool类型的使能信号，为true.B时计数器从0开始每个时钟上升沿加1自增，为false.B时则计数器保持不变；第二个参数需要一个Int类型的具体正数，当计数到该值时归零。该方法返回一个二元组，其第一个元素是计数器的计数值，第二个元素是判断计数值是否等于期望值的结果。工厂方法的另一个重载版本没有使能信号。</p>
<p>有如下示例代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// counter.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> valid = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())  <br>  &#125;)<br><br>  <span class="hljs-keyword">val</span> (a, b) = <span class="hljs-type">Counter</span>(io.en, <span class="hljs-number">233</span>)<br>  io.out := a<br>  io.valid := b<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>它生成的主要Verilog代码为：</p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// MyCounter.v</span><br><span class="hljs-keyword">module</span> MyCounter(<br>  <span class="hljs-keyword">input</span>        clock,<br>  <span class="hljs-keyword">input</span>        reset,<br>  <span class="hljs-keyword">input</span>        io_en,<br>  <span class="hljs-keyword">output</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] io_out,<br>  <span class="hljs-keyword">output</span>       io_valid<br>);<br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] value; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T; <br>  <span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] <span class="hljs-number">_</span>T_2; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T = value == <span class="hljs-number">8&#x27;he8</span>; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_2 = value + <span class="hljs-number">8&#x27;h1</span>; <br>  <span class="hljs-keyword">assign</span> io_out = value; <br>  <span class="hljs-keyword">assign</span> io_valid = io_en &amp; <span class="hljs-number">_</span>T; <br><br>  <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clock) <span class="hljs-keyword">begin</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      value &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (io_en) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">_</span>T) <span class="hljs-keyword">begin</span><br>          value &lt;= <span class="hljs-number">8&#x27;h0</span>;<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>          value &lt;= <span class="hljs-number">_</span>T_2;<br>        <span class="hljs-keyword">end</span><br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<h2 id="4-7-16位线性反馈移位寄存器"><a href="#4-7-16位线性反馈移位寄存器" class="headerlink" title="4.7 16位线性反馈移位寄存器"></a>4.7 16位线性反馈移位寄存器</h2><p>如果要产生伪随机数，可以使用util包里的16位线性反馈移位寄存器原语LFSR16，它接收一个Bool类型的使能信号，用于控制寄存器是否移位，缺省值为true.B。它返回一个UInt(16.W)类型的结果。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// lfsr.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LFSR</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> en = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">16.</span><span class="hljs-type">W</span>))  <br>  &#125;)<br><br>  io.out := <span class="hljs-type">LFSR16</span>(io.en)<br>&#125;<br>它生成的主要<span class="hljs-type">Verilog</span>代码为：<br><br><span class="hljs-comment">// LFSR.v</span><br>module <span class="hljs-type">LFSR</span>(<br>  input         clock,<br>  input         reset,<br>  input         io_en,<br>  output [<span class="hljs-number">15</span>:<span class="hljs-number">0</span>] io_out<br>);<br>  reg [<span class="hljs-number">15</span>:<span class="hljs-number">0</span>] _T;<br>  wire  _T_1; <br>  wire  _T_2; <br>  wire  _T_3; <br>  wire  _T_4; <br>  wire  _T_5; <br>  wire  _T_6; <br>  wire  _T_7; <br>  wire [<span class="hljs-number">14</span>:<span class="hljs-number">0</span>] _T_8; <br>  wire [<span class="hljs-number">15</span>:<span class="hljs-number">0</span>] _T_9; <br>  assign _T_1 = _T[<span class="hljs-number">0</span>]; <br>  assign _T_2 = _T[<span class="hljs-number">2</span>]; <br>  assign _T_3 = _T_1 ^ _T_2; <br>  assign _T_4 = _T[<span class="hljs-number">3</span>]; <br>  assign _T_5 = _T_3 ^ _T_4; <br>  assign _T_6 = _T[<span class="hljs-number">5</span>]; <br>  assign _T_7 = _T_5 ^ _T_6; <br>  assign _T_8 = _T[<span class="hljs-number">15</span>:<span class="hljs-number">1</span>]; <br>  assign _T_9 = &#123;_T_7,_T_8&#125;; <br>  assign io_out = _T; <br><br>  always @(posedge clock) begin<br>    <span class="hljs-keyword">if</span> (reset) begin<br>      _T &lt;= <span class="hljs-number">16</span><span class="hljs-symbol">&#x27;h1</span>;<br>    end <span class="hljs-keyword">else</span> begin<br>      <span class="hljs-keyword">if</span> (io_en) begin<br>        _T &lt;= _T_9;<br>      end<br>    end<br>  end<br>endmodule<br></code></pre></div></td></tr></table></figure>
<h2 id="4-8-状态机"><a href="#4-8-状态机" class="headerlink" title="4.8 状态机"></a>4.8 状态机</h2><p>状态机也是常用电路，但是Chisel没有直接构建状态机的原语。不过，util包里定义了一个<strong>Enum特质及其伴生对象</strong>。伴生对象里的apply方法定义如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>(n: <span class="hljs-type">Int</span>): <span class="hljs-type">List</span>[<span class="hljs-type">UInt</span>]<br></code></pre></div></td></tr></table></figure>
<p>它会根据参数n返回对应元素数的List[UInt]，每个元素都是不同的，所以可以作为枚举值来使用。最好把枚举状态的变量名也组成一个列表，然后用列表的模式匹配来进行赋值。有了枚举值后，可以通过“switch…is…is”语句来使用。其中，switch里是相应的状态寄存器，而每个is分支的后面则是枚举值及相应的定义。例如检测持续时间超过两个时钟周期的高电平：</p>
<figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-comment">// fsm.scala</span><br><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> chisel3._<br><span class="hljs-keyword">import</span> chisel3.util._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DetectTwoOnes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> &#123;<br>    <span class="hljs-keyword">val</span> in = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">Bool</span>())<br>  &#125;)<br><br>  <span class="hljs-keyword">val</span> sNone :: sOne1 :: sTwo1s :: <span class="hljs-type">Nil</span> = <span class="hljs-type">Enum</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-keyword">val</span> state = <span class="hljs-type">RegInit</span>(sNone)<br><br>  io.out := (state === sTwo1s)<br><br>  switch (state) &#123;<br>    is (sNone) &#123;<br>      when (io.in) &#123;<br>        state := sOne1<br>      &#125;<br>    &#125;<br>    is (sOne1) &#123;<br>      when (io.in) &#123;<br>        state := sTwo1s<br>      &#125; .otherwise &#123;<br>        state := sNone<br>      &#125;<br>    &#125;<br>    is (sTwo1s) &#123;<br>      when (!io.in) &#123;<br>        state := sNone<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>注意，枚举状态名的首字母要小写，这样Scala的编译器才能识别成变量模式匹配。它生成的Verilog为：</p>
<figure class="highlight verilog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs verilog"><span class="hljs-comment">// DetectTwoOnes.v</span><br><span class="hljs-keyword">module</span> DetectTwoOnes(<br>  <span class="hljs-keyword">input</span>   clock,<br>  <span class="hljs-keyword">input</span>   reset,<br>  <span class="hljs-keyword">input</span>   io_in,<br>  <span class="hljs-keyword">output</span>  io_out<br>);<br>  <span class="hljs-keyword">reg</span> [<span class="hljs-number">1</span>:<span class="hljs-number">0</span>] state; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_1; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_2; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_3; <br>  <span class="hljs-keyword">wire</span>  <span class="hljs-number">_</span>T_4; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_1 = <span class="hljs-number">2&#x27;h0</span> == state; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_2 = <span class="hljs-number">2&#x27;h1</span> == state; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_3 = <span class="hljs-number">2&#x27;h2</span> == state; <br>  <span class="hljs-keyword">assign</span> <span class="hljs-number">_</span>T_4 = io_in == <span class="hljs-number">1&#x27;h0</span>; <br>  <span class="hljs-keyword">assign</span> io_out = state == <span class="hljs-number">2&#x27;h2</span>;<br>  <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clock) <span class="hljs-keyword">begin</span><br>    <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>      state &lt;= <span class="hljs-number">2&#x27;h0</span>;<br>    <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-number">_</span>T_1) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span> (io_in) <span class="hljs-keyword">begin</span><br>          state &lt;= <span class="hljs-number">2&#x27;h1</span>;<br>        <span class="hljs-keyword">end</span><br>      <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">_</span>T_2) <span class="hljs-keyword">begin</span><br>          <span class="hljs-keyword">if</span> (io_in) <span class="hljs-keyword">begin</span><br>            state &lt;= <span class="hljs-number">2&#x27;h2</span>;<br>          <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            state &lt;= <span class="hljs-number">2&#x27;h0</span>;<br>          <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>          <span class="hljs-keyword">if</span> (<span class="hljs-number">_</span>T_3) <span class="hljs-keyword">begin</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-number">_</span>T_4) <span class="hljs-keyword">begin</span><br>              state &lt;= <span class="hljs-number">2&#x27;h0</span>;<br>            <span class="hljs-keyword">end</span><br>          <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></div></td></tr></table></figure>
<hr>
<p><img src="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p2.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p3.jpg" srcset="/img/loading.gif" lazyload alt="96733090_p3"></p>
<p><img src="https://markdownpic-1301418409.cos.ap-nanjing.myqcloud.com/img/markdown_1/96733090_p4.jpg" srcset="/img/loading.gif" lazyload alt="96733090_p4"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/IC/">IC</a>
                    
                      <a class="hover-with-bg" href="/categories/IC/Chiesl/">Chiesl</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/IC/">IC</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/202203092029/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/Linuxessay/debug/%E8%A7%A3%E5%86%B3Ubuntu%E4%BF%AE%E6%94%B9%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%90%8E%E5%AF%BC%E8%87%B4%E7%99%BB%E5%BD%95%E5%BE%AA%E7%8E%AF%E8%BF%9B%E4%B8%8D%E5%8E%BB%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%97%AE%E9%A2%98/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">解决Ubuntu修改环境变量后导致登录循环进不去系统的问题</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/202203041717/CS/Scalaessay/cs/scala/2022-3-4-scala/">
                        <span class="hidden-mobile">Scala（二）：进阶篇</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'preferred-color-scheme';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'GreensCH/commitutterances');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span> | </span> <a href="https://weibo.com/u/7453939976" target="_blank" rel="nofollow noopener"> Green Weibo</a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        loader: {
          load: ['ui/lazy']
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" ></script>

  





  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?eca4a4d34dadf0d4e282cc6ef2dc3de6";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script>
  <link defer rel="stylesheet" href="/css/backgroundize.css" />
  
  <div id="aplayer" style="width:300px"></div>
  <link defer rel="stylesheet" href="https://cdn.staticfile.org/aplayer/1.10.1/APlayer.min.css" />
  <script src="https://cdn.staticfile.org/aplayer/1.10.1/APlayer.min.js"></script>
  <script defer src="/js/aplayer.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"superSample":1,"position":"left","width":250,"height":500,"vOffset":-18},"mobile":{"show":false},"dialog":{"enable":false,"hitokoto":true,"width":10,"height":10,"vOffset":-100},"log":false});</script></body>
</html>
